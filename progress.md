Original prompt: specの中に仕様が入っているので読んでください。まずは最小限で、ダンジョンの自動生成を行い画面に表示するコードを書いてください。ダンジョンの仕様は「ダンジョン仕様_v1.md」に書いています。ダンジョンタイルの置き方の例は「ダンジョンタイル設定.md」に書いています。map_tipはmap_tip/dungeon_01の中に入っています。コードは責務ごとにファイルを分けるなど可読性を高めてください。

- 2026-02-08: Initial implementation start. Using static HTML + ES Modules.
- 2026-02-08: Scope locked to v1 minimal generation + tile rendering with A-L symbols.
- 2026-02-08: Added core modules (rng/grid/generator/validator) and rendering/UI modules.
- 2026-02-08: Added static entrypoint (index.html), stylesheet, and seed-driven regenerate controls.
- 2026-02-08: Added generation check script and Playwright idle action payload.
- 2026-02-08: Validation complete: `node scripts/check_generation.mjs` passed 100/100.
- 2026-02-08: Playwright checks complete on local server: initial load, state JSON output, and random regenerate button behavior verified; no console error artifacts produced.
- TODO: Add gameplay entities (enemy/trap/chest placement) on top of current room metadata.
- TODO: Add camera/player and interaction loop after static map rendering baseline.
- 2026-02-08: Cleaned test artifacts from repository (`output/`).
- 2026-02-08: Fixed wall symbol conversion so A/C reliably become F/G.
- 2026-02-08: Fixed tall-wall overlap by clipping B/F/G draw height to contiguous floor depth below each wall tile.
- 2026-02-08: Swapped F/G mapping direction to match expected corner orientation.
- 2026-02-08: Updated corridor generation to reserve 5-tile wall height + 1-tile walkway for horizontal paths, and restored full 160px rendering for B/F/G.
- 2026-02-08: Fixed H/J conversion logic to use bottom+inner-side wall continuity, reducing K/L leakage on lower inner corners.
- 2026-02-08: Swapped H/J assignment for inner-bottom corners to match visual orientation.
- 2026-02-08: Refactored wall symbol resolver into clear stages (floor adjacency, primary symbol, secondary corner conversion) without behavior changes.
- 2026-02-08: Adjusted K/L -> J/H conversion to also treat out-of-bounds below as corner-valid when side wall continuity exists.
- 2026-02-08: Refined K/L -> J/H conversion: prefer below-wall continuation, with boundary fallback using side-wall continuity.
- 2026-02-08: Added player movement system (mouse hold-follow movement, 32x32 feet-only collision, stop on wall hit, no wall-slide).
- 2026-02-08: Added player sprite loading (`graphic/player/player_tip/char_p_hero_m03a.png`) and directional animation rows with loop sequence A->B->C->B (idle=B).
- 2026-02-08: Switched renderer to cached dungeon backdrop + per-frame player composite rendering.
- 2026-02-08: Added fixed-step game loop (`1/60`) and updated `window.advanceTime(ms)` to step simulation deterministically.
- 2026-02-08: Added pointer controller with capture-based drag tracking (down/move/up/cancel).
- 2026-02-08: Extended `render_game_to_text` with player state (`x,y,width,height,feetHitbox,facing,isMoving,target`).
- 2026-02-08: Added auto camera follow using `#canvas-scroll` centered on player feet.
- 2026-02-08: Added Playwright action payloads for move and wall-stop checks (`tests/actions/player_move_click.json`, `tests/actions/player_wall_stop.json`).
- 2026-02-08: Validation complete: `npm run check:generation` passed 100/100 after movement integration.
- 2026-02-08: Playwright checks complete: player moved to right/left targets, wall-stop kept feet hitbox on floor tiles, and no `errors-*.json` console artifacts were generated.
- 2026-02-08: Verified drag-follow behavior: while pointer held, changing cursor from right target to left target flipped facing (`right` -> `left`) and updated `player.target`; releasing pointer set `target=null` and stopped movement.
- 2026-02-08: Verified camera follow with small viewport (`360x280`): `#canvas-scroll.scrollLeft` changed `284 -> 348` during rightward movement, keeping player in view.
- 2026-02-08: Verified animation sequence logic in `getPlayerFrame`: moving frame columns cycle `[0,1,2,1]` and idle frame column remains `1`.
- 2026-02-08: Fixed collision mismatch for tall top walls (`B/F/G`, 32x160). Added `walkableGrid` that blocks the full 5-tile covered area below tall-wall symbols.
- 2026-02-08: Updated player movement collision to use `walkableGrid` (fallback to `floorGrid`), preventing entry into visually covered wall area.
- 2026-02-08: Added spawn fallback in start room to avoid spawning into blocked tall-wall coverage; picks nearest valid tile if center is blocked.
- 2026-02-08: Updated Playwright action coordinates for the new blocked-area behavior (`player_move_click.json`, `player_wall_stop.json`).
- 2026-02-08: Re-verified with Playwright: move case reached `(x=512.02,y=1489.73)` and wall-stop case stayed at `(x=448,y=1440)` with no console error artifacts.
- 2026-02-08: Increased player move speed slightly from `4.0` to `4.5` tiles/sec (`128 -> 144 px/sec`) in `src/config/constants.js`.
- 2026-02-08: Added wall-slide behavior: when diagonal movement hits a wall, movement now falls back to X-only or Y-only step if either axis is walkable.
- 2026-02-08: Verified wall-slide fallback with targeted simulation (`updatePlayer` + mocked walkable grid): diagonal input against top wall produced `dx>0, dy=0` as expected.
- TODO: Add gameplay entities (enemy/trap/chest placement) on top of current room metadata.
- TODO: Consider adding an automated assertion script for animation frame transitions (A/B/C/B) to complement screenshot-based verification.
- 2026-02-08: Added enemy loading pipeline for `type=walk` (`src/enemy/enemyDb.js`, `src/enemy/enemyAsset.js`) and validated required DB keys before use.
- 2026-02-08: Added walk enemy system (`src/enemy/enemySystem.js`) with per-room spawn (excluding start room), height-based wall hitbox rules, and 4-direction random walk.
- 2026-02-08: Integrated enemies into app state, simulation loop, renderer z-sort, and `render_game_to_text` output (`enemies` with wall hitbox/facing/movement).
- 2026-02-08: Added automated enemy behavior check script (`npm run check:enemy-walk`) and Playwright action payload `tests/actions/enemy_idle_walk.json`.
- 2026-02-08: Updated enemy DB loader to discover `db/enemy_db/*.json` from directory listing with fallback list, keeping `type=walk` filter.
- 2026-02-08: Validation complete: `npm run check:generation` and `npm run check:enemy-walk` both passed after enemy integration.
- 2026-02-08: Playwright check complete for idle enemy walk (`tests/actions/enemy_idle_walk.json`): 3 screenshots + state JSON captured, `enemies` present in text state, no `errors-*.json` artifacts.
- 2026-02-08: Added `type=fly` support by generalizing enemy creation to `createEnemies` and loading all enemy DB records.
- 2026-02-08: Implemented fly pass-through behavior (ignores wall collision), with fly collision probe using center point over a passable grid (`floor || symbol`).
- 2026-02-08: Updated text state for fly enemies (`wallHitbox: null`) while keeping walk enemies' wall hitbox output.
- 2026-02-08: Added `npm run check:enemy-fly` (`scripts/check_enemy_fly.mjs`) to verify fly spawn/movement and wall-pass behavior.
- 2026-02-08: Playwright verification complete for mixed walk+fly enemies (`output/web-game-enemy-fly`): `type=fly` present in state JSON and no `errors-*.json` artifacts.
- 2026-02-08: Fixed enemy DB refresh behavior: regeneration now re-reads enemy definitions/assets each time (`regenerate` async + `refreshEnemyResources`).
- 2026-02-08: Fixed stale JSON cache issue by fetching enemy DB directory/files with `cache: "no-store"` and cache-bust query (`cb=`) in `src/enemy/enemyDb.js`.
- 2026-02-08: Verified hot-reload behavior without page refresh: changing `bat01.json` width while page open and calling `window.__regenDungeon(...)` updated fly width `64 -> 32 -> 64`.
- 2026-02-08: Added enemy notice/giveup behavior (`random_walk` <-> `chase`) for walk+fly in `src/enemy/enemySystem.js`; chase speed multiplier set to `1.3x` and `updateEnemies` now accepts optional `player`.
- 2026-02-08: Added LOS-gated notice for `walk` enemies using Bresenham tile checks over `dungeon.walkableGrid`; `fly` notice remains distance-only.
- 2026-02-08: Extended `render_game_to_text` enemy payload with `behaviorMode`, `noticeRadiusPx`, `giveupRadiusPx`, and `isChasing`.
- 2026-02-08: Added `scripts/check_enemy_notice_giveup.mjs` and npm script `check:enemy-notice-giveup`; verified notice/LOS/giveup/speed-ratio cases pass.
- 2026-02-08: Reworked Playwright payload `tests/actions/enemy_notice_giveup.json` to a deterministic visible-route sequence; verified `state-0.json` contains chasing enemies and no `errors-*.json`.
- TODO: If we need a Playwright artifact that proves both notice and giveup in one run, extend the client to emit per-step state snapshots (current script only writes end-of-iteration state).
- 2026-02-08: Updated spec documents for enemy chase behavior details: added notice/giveup state-machine rules (walk LOS / fly no LOS, distance basis, 1.3x chase speed) and v1 enemy placement notes in `spec/` and `spec_logic/`.
- 2026-02-09: Added Vitest-based unit testing foundation (`devDependency: vitest`) and npm scripts `unit`, `test:checks`, `test`.
- 2026-02-09: Added unit tests for high-risk uncovered modules:
  - `tests/unit/playerSystem.test.js` (spawn/fallback, pointer target, update/movement/collision/slide, frame sequence, hitbox rounding)
  - `tests/unit/pointerController.test.js` (left-click gating, active pointer filtering, coordinate scaling+clamp, release events, destroy cleanup)
  - `tests/unit/appState.test.js` (init state, dungeon state transition, error state reset/stringification)
- 2026-02-09: Validation complete:
  - `npm run unit` -> PASS (3 files, 20 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup)
  - `npm test` -> PASS (unit + checks)
- 2026-02-09: Playwright smoke check executed with idle action payload using skill client (`tests/actions/idle.json`) against local server; screenshot + state JSON captured under `/tmp/rogue_like_game_playwright_smoke` and visually/state-checked with no console-error artifacts generated.
- 2026-02-09: Added player auto-attack v1 with initial weapon load (`weapon_sword_01`) + circle formation (`formation_circle_01`), including runtime weapon orbit, attack sequence cooldown, hit_set gating, hit_num, and pierce_count rules.
- 2026-02-09: Added weapon data pipeline and assets:
  - `src/weapon/weaponDb.js` (DB discovery + validation + normalization)
  - `src/weapon/formationDb.js` (formation discovery + validation + normalization)
  - `src/weapon/weaponAsset.js` (weapon sprite loading)
  - `src/weapon/weaponSystem.js` (weapon runtime, circle+biased_center motion, AABB combat, enemy prune helper)
- 2026-02-09: Extended app state with `weapons` and wired dungeon lifecycle to reset/populate weapon runtime.
- 2026-02-09: Extended enemy definition normalization to include combat/stat fields (`vit/for/agi/pow/tec/arc/rank/role/tags`) with defaults.
- 2026-02-09: Added enemy combat fields in runtime (`maxHp/hp/isDead/attackDamage/moveSpeed`) and combat hitbox export (`getEnemyCombatHitbox`); dead enemies are skipped during enemy updates.
- 2026-02-09: Integrated combat update order into main loop:
  - `updatePlayer -> updateEnemies -> updateWeaponsAndCombat -> removeDefeatedEnemies -> followPlayerInView`
- 2026-02-09: Extended renderer to support weapon drawables in the shared feetY depth queue.
- 2026-02-09: Extended `render_game_to_text` payload:
  - `player.weapons[]` with position/attackSeq/cooldown/hitbox
  - `enemies[]` with `hp/maxHp/isDead/attackDamage/moveSpeed`
- 2026-02-09: Added tests:
  - `tests/unit/weaponSystem.test.js` for attack_seq, hit_set reset, hit_num/pierce_count, and biased_center behavior.
  - `tests/unit/enemySystem.test.js` for enemy stat initialization + combat hitbox.
  - updated `tests/unit/appState.test.js` for `weapons` state.
- 2026-02-09: Added combat check script `scripts/check_player_attack.mjs` and npm script `check:player-attack`; linked into `test:checks`.
- 2026-02-09: Added Playwright action payload `tests/actions/player_attack_auto.json`.
- 2026-02-09: Validation complete:
  - `npm run unit` -> PASS (5 files, 27 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/player-attack)
  - `npm test` -> PASS
- 2026-02-09: Playwright verification run completed using skill client against local server with route movement action:
  - output dir: `output/web-game-player-attack`
  - `state-0.json` shows weapon runtime fields populated, enemy HP reduction (e.g. one enemy `173 -> 125`), and enemy count decrease (`8 -> 7`) confirming kill + prune.
  - screenshot `shot-0.png` reviewed for on-screen weapon rendering and gameplay state.

- TODO: Add dedicated deterministic Playwright scenario that guarantees a nearby enemy at spawn so "idle-only" auto-attack can always demonstrate HP drop without movement routing.
- TODO: If we later add non-circle formations, extend `weaponSystem` with per-type trajectory resolvers and dedicated unit coverage per formation type.

- 2026-02-09: Added combat feedback v1 visuals on top of auto-attack:
  - weapon sprite rotation bound to orbit vector (`up=0°/right=90°/down=180°/left=270°`) via `rotationDeg/rotationRad` in weapon runtime.
  - enemy hit flash timer + alpha decay (`hitFlashTimerSec`, `hitFlashDurationSec`, `getEnemyHitFlashAlpha`).
  - damage popup lifecycle module (`src/combat/combatFeedbackSystem.js`) with rise/fade/expiry.
- 2026-02-09: Main loop integration updated:
  - `stepSimulation` now consumes `CombatEvent[]` from `updateWeaponsAndCombat`, spawns/updates `damagePopups`, and continues dead-enemy prune.
  - `renderCurrentFrame` now passes `weapon.rotationRad`, enemy `flashAlpha`, and `damagePopups` to renderer.
  - `render_game_to_text` now includes `player.weapons[].rotationDeg`, `enemies[].hitFlashAlpha`, and root `damagePopups[]`.
- 2026-02-09: Added/updated tests for feedback behavior:
  - `tests/unit/combatFeedbackSystem.test.js` (spawn, rise/fade, expiry)
  - `tests/unit/weaponSystem.test.js` (rotation angle mapping + combat event and flash trigger)
  - `tests/unit/enemySystem.test.js` (flash decay and alpha clamp)
  - `tests/unit/appState.test.js` (damagePopups state wiring)
- 2026-02-09: Updated check script `scripts/check_player_attack.mjs` to assert damage event emission, popup generation/decay, flash trigger/decay, and kill prune path.
- 2026-02-09: Added Playwright action payload `tests/actions/player_attack_feedback.json` and verified feedback states with skill client:
  - output dir: `/Users/mineo.matsuya/Desktop/code/rogue_like_game/output/web-game-player-attack-feedback`
  - observed `state-21.json`: `damagePopups[0].alpha=0.81`, enemy `hitFlashAlpha=0.44`, weapon `rotationDeg=166.61`.
  - observed `state-22.json`: same popup decayed to `alpha=0.19` and higher Y (upward movement).
  - observed subsequent state: popup removed after lifetime; no `errors-*.json` artifacts generated.
- TODO: For clearer visual QA, consider a temporary debug zoom/marker mode around player combat area to make popup/flash easier to inspect in full-map captures.
- 2026-02-09: Updated related specs to match implemented combat feedback and runtime values:
  - `spec/武器システム仕様_v1_4.md`: added v1 feedback rules (weapon rotation angle convention, damage popups, enemy hit flash), reflected current starter weapon values (`weapon_sword_01`, `formation_id_circle01`, `pierce_count=10`), and documented `render_game_to_text` combat debug fields.
  - `spec/敵キャラ仕様_v1_5.md`: added hit-flash runtime behavior (`hitFlashTimerSec`, `hitFlashDurationSec`, `hitFlashAlpha`) and updated weapon-spec reference link.
  - aligned cross-document references from `武器システム仕様_v1.md` to `武器システム仕様_v1_4.md` in `spec/ゲーム概要_v2.md`, `spec/ステータス仕様_v1_3.md`, and `spec/ダンジョン仕様_v1.md`.

- 2026-02-09: Added pause toggle button to debug panel (`#pause-toggle`) with pressed-state styling and label switch (`一時停止` <-> `再開`).
- 2026-02-09: Extended app state with `isPaused` and reset-to-false behavior in `setDungeonState`/`setErrorState` to guarantee auto-resume after Apply Seed/再生成.
- 2026-02-09: Integrated pause control into main loop:
  - `stepSimulation` now early-returns when paused.
  - pointer input ignores new active targets while paused (release event still allowed).
  - `window.advanceTime(ms)` no-ops simulation during pause.
  - `render_game_to_text` now exports `isPaused` in dungeon mode.
- 2026-02-09: Added unit test coverage for pause-related UI/state:
  - updated `tests/unit/appState.test.js` for `isPaused` initialization/reset.
  - added `tests/unit/debugPanel.test.js` for pause toggle handler + label/`aria-pressed` updates.
- 2026-02-09: Validation complete for pause feature:
  - `npm run unit` -> PASS (7 files, 34 tests)
  - `npm test` -> PASS (unit + all check scripts)
  - Playwright verification (`output/web-game-pause-verification/verification.json`) -> PASS:
    - paused frames kept player/enemy state unchanged,
    - resume re-enabled progression,
    - regenerate while paused auto-reset `isPaused=false`,
    - no console error artifacts.
- 2026-02-10: Implemented PlayerState JSON persistence (spec v1.4.1) as canonical persisted data using localStorage key `rogue_like_game.player_state_v1`.
- 2026-02-10: Added `src/player/playerStateStore.js`:
  - schema constants (`player_state_v1`, storage key), default/sanitized state builders,
  - load/save helpers for localStorage,
  - runtime sync (`run.pos`, weapon runtime),
  - weapon-definition reconstruction from saved snake_case JSON,
  - saved weapon runtime apply (`attack_seq`, `cooldown_remaining_sec`).
- 2026-02-10: Added `loadWeaponRawRecord(fileName)` in `src/weapon/weaponDb.js` to fetch+validate raw snake_case weapon JSON.
- 2026-02-10: Added `tryRestorePlayerPosition(player, dungeon, savedPos)` in `src/player/playerSystem.js` (walkable+bounds aware restore).
- 2026-02-10: Extended app state with `playerState` in `src/state/appState.js` and wired through `setDungeonState`.
- 2026-02-10: Integrated persistence flow in `src/main.js`:
  - load playerState on startup from localStorage,
  - regenerate restores saved position when valid,
  - equipped weapons are rebuilt from saved spec-shape JSON (fallback to initial DB weapon),
  - saved weapon runtime applied to runtime weapons,
  - simulation syncs playerState each tick,
  - autosave every 1s + beforeunload forced save,
  - `render_game_to_text` now includes `playerState` in loading/error/dungeon payloads.
- 2026-02-10: Added/updated unit tests:
  - added `tests/unit/playerStateStore.test.js` (default shape, sword copy, broken-save sanitize, runtime sync/save, weapon-restore runtime apply),
  - updated `tests/unit/playerSystem.test.js` for `tryRestorePlayerPosition` success/block/clamp cases,
  - updated `tests/unit/appState.test.js` for `playerState` state wiring.
- 2026-02-10: Validation complete:
  - `npm run unit` -> PASS (8 files, 41 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/player-attack)
  - Playwright skill client run with `tests/actions/idle.json` produced `output/web-game-player-state-save` artifacts;
    `state-0.json` includes `playerState.schema_version=player_state_v1` and `run.equipped_weapons[0].weapon` sword fields.
  - Additional Playwright restore scenario (local script using same playwright runtime) passed:
    saved valid moved position restored after reload, invalid saved position safely fell back to valid in-bounds walkable position.

- TODO: If player HP runtime is introduced later, wire `playerState.run.hp` to true runtime HP source (currently synced from player if available, otherwise maintained default/saved value).
- TODO: If multiple weapon DB entries and assets are added, ensure saved weapon IDs/file names are validated against available assets and decide fallback policy for missing sprites.
- 2026-02-10: Updated weapon persistence model to spec-normalized WeaponDef + WeaponInstance split.
- 2026-02-10: Reworked `src/player/playerStateStore.js` to store weapon instances as:
  - `weapon_def_id`, `rarity`, `weapon_plus`, `formation_id`, `skills` (+ optional `stat_overrides`).
  - Def fields like `weapon_file_name`, `width`, `base_damage`, `attack_cooldown_sec` are no longer saved in player_state.
- 2026-02-10: Added strict legacy invalidation policy (no migration):
  - If saved weapon object includes legacy def keys (e.g. `weapon_file_name`, `base_damage`) or lacks valid `weapon_def_id`, load path discards save and reinitializes default player state.
- 2026-02-10: Changed player state load/resolve flow to use weapon definition map:
  - `loadPlayerStateFromStorage(storage, key, weaponDefinitionsById, starterWeaponDefId, nowUnixSec)`
  - `buildWeaponDefinitionsFromPlayerState(playerState, weaponDefinitionsById, starterWeaponDefId)` returns resolved runtime weapon definitions by merging WeaponDef + WeaponInstance.
- 2026-02-10: Removed `loadWeaponRawRecord` dependency from `src/main.js` and removed unused raw-record loader export from `src/weapon/weaponDb.js`.
- 2026-02-10: `src/main.js` now resolves runtime weapons via `weapon_def_id` and applies safe formation fallback:
  - if saved `formation_id` is missing in current formation DB, fallback to weapon def's default formation, then first available formation.
- 2026-02-10: Updated `tests/unit/playerStateStore.test.js` for new instance shape and behaviors:
  - default state stores instance-only weapon fields,
  - legacy save is discarded and reset,
  - weapon_def_id resolution + formation override merge,
  - runtime sync/save/apply does not mutate instance payload.
- 2026-02-10: Validation complete:
  - `npm run unit` -> PASS (8 files, 41 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/player-attack)
  - Playwright skill-client run (`output/web-game-weapon-instance-spec`) confirmed state output includes `weapon_def_id` and excludes def-fixed fields.
  - Legacy injection run (`output/web-game-weapon-instance-legacy-check`) confirmed old save payload is discarded and rewritten as normalized instance format.
  - Formation override run (`output/web-game-weapon-instance-formation-check`) confirmed runtime remains stable with invalid saved formation id via fallback, while playerState keeps saved instance value.

- TODO: When more formation files are introduced, decide whether to auto-normalize invalid saved `formation_id` inside persisted playerState (currently runtime fallback only).
- 2026-02-10: Normalized weapon typo naming across the repository (legacy misspelling -> `weapon`) for IDs, key names, DB/asset paths, and docs.
- 2026-02-10: Renamed tracked weapon resources/paths:
  - `db/<legacy-typo>_db/*` -> `db/weapon_db/*`
  - `db/weapon_db/<legacy-typo>_sword_01.json` -> `db/weapon_db/weapon_sword_01.json`
  - `db/weapon_db/<legacy-typo>_db_template/<legacy-typo>_db_template.json` -> `db/weapon_db/weapon_db_template/weapon_db_template.json`
  - `graphic/<legacy-typo>/<legacy-typo>_tip/<legacy-typo>_sword_01.png` -> `graphic/weapon/weapon_tip/weapon_sword_01.png`
- 2026-02-10: Validation complete after typo normalization:
  - `rg -n '<legacy-typo-pattern>' .` -> 0 hits
  - `npm run unit` -> PASS (8 files, 41 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/player-attack)
  - `npm test` -> PASS
  - Playwright skill-client smoke (`tests/actions/idle.json`) output at `output/web-game-weapon-typo-fix`:
    - `state-0.json` includes `weapon_sword_01` in `weaponDefId` / `weapon_def_id`
    - no `errors-*.json` artifacts generated.
- 2026-02-10: Switched weapon definition ID source from filename to JSON `id` in `src/weapon/weaponDb.js`.
- 2026-02-10: Added weapon DB validation policy updates: required `id`, filename/id mismatch warning with JSON-id priority, duplicate-id hard error.
- 2026-02-10: Updated starter weapon ID resolution in `src/main.js` to prefer `INITIAL_WEAPON_ID` and fallback to first loaded weapon definition ID.
- 2026-02-10: Updated `syncPlayerStateFromRuntime` missing-slot behavior to prefer runtime `weaponDefId` and fallback to default only when invalid.
- 2026-02-10: Added new unit suite `tests/unit/weaponDb.test.js` and expanded `tests/unit/playerStateStore.test.js` for runtime `weaponDefId` slot-fill behavior.
- 2026-02-10: Validation run complete after weapon-id refactor.
  - `npm run unit` PASS (9 files / 47 tests)
  - `npm run test:checks` PASS
  - Playwright client run (`output/web-game-weapon-id-ref`) produced `shot-0.png` + `state-0.json`; no `errors-*.json` artifact generated.
- 2026-02-10: Added debug panel localStorage inspection feature.
  - UI: added `Storage表示` button and storage output area in debug panel (`index.html`, `styles/main.css`).
  - Logic: `main.js` now builds a readable localStorage dump (JSON pretty-print when possible) and wires button handler via `debugPanel.setStorageDump(...)`.
  - Tests: expanded `tests/unit/debugPanel.test.js` for storage button callback and dump visibility toggling.
- 2026-02-10: Implemented enemy attack v1.1 with weapon-object rendering + trajectories.
  - Added enemy DB loaders:
    - `src/enemy/enemyAiProfileDb.js` (ai_profile discovery/validation/normalize)
    - `src/enemy/enemyWeaponLoadoutDb.js` (enemy loadout discovery/validation/normalize)
  - Extended enemy definition normalization (`src/enemy/enemyDb.js`) with `aiProfileId` and `weaponLoadoutId`.
  - Reworked `src/enemy/enemySystem.js` to add enemy attack runtime:
    - attack phases: `cooldown -> windup -> attack -> recover`
    - windup telegraph alpha (red blink), locked aim dir, LOS/range gating, and per-weapon hit gating
    - enemy weapon runtime transform update (circle formation) and visibility modes (`burst`/`always`)
    - enemy-to-player combat events via weapon AABB vs player AABB
    - new exports: `updateEnemyAttacks`, `getEnemyTelegraphAlpha`, `getEnemyWeaponRuntimes`
  - Integrated enemy attack systems in `src/main.js`:
    - merged player and enemy combat events for popup generation
    - loaded/resolved enemy AI + loadout + weapon/formation into per-enemy attack profiles
    - render wiring for enemy telegraph and enemy weapon drawables
    - text-state extensions: player hp/maxHp/hitFlashAlpha, enemy attackPhase/telegraphAlpha/weapons, popup targetType
  - Added player damage feedback in `src/player/playerSystem.js`:
    - player runtime hp/maxHp and white hit-flash decay
    - `getPlayerCombatHitbox` and `getPlayerHitFlashAlpha`
  - Added popup target typing in `src/combat/combatFeedbackSystem.js` and red player-damage popup color in renderer.
  - Added player HP visibility in debug panel stats (`HP: current / max`) with runtime refresh.
- 2026-02-10: Added tests/checks for enemy attack feature.
  - Added unit tests:
    - `tests/unit/enemyAiProfileDb.test.js`
    - `tests/unit/enemyWeaponLoadoutDb.test.js`
  - Expanded unit tests:
    - `tests/unit/enemySystem.test.js` (telegraph/phase transitions/weapon-hit damage)
    - `tests/unit/playerSystem.test.js` (player flash + hp defaults)
    - `tests/unit/combatFeedbackSystem.test.js` (popup targetType)
    - `tests/unit/weaponSystem.test.js` (enemy targetType on damage events)
  - Added integration check script:
    - `scripts/check_enemy_attack.mjs`
  - Updated npm scripts:
    - `check:enemy-attack`
    - linked into `test:checks`
- 2026-02-10: Validation complete after enemy attack integration:
  - `npm run unit` -> PASS (11 files, 59 tests)
  - `npm run check:enemy-attack` -> PASS
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/enemy-attack/player-attack)
  - `npm test` -> PASS

- TODO: Tune enemy attack trigger feel (currently gated by `weapon_active_range_tiles` and `los_required` from AI profile; default profile may feel conservative in live movement).
- TODO: Add deterministic Playwright scenario specifically for enemy-attack visibility (telegraph -> weapon visible -> player red popup/white flash) once a stable near-enemy route payload is prepared.
- 2026-02-11: Added debug utilities requested by user.
  - Added debug panel buttons in `index.html`:
    - `#reset-storage` (Storageリセット)
    - `#damage-preview-toggle` (被ダメ有効 / 被ダメ無効(演出のみ))
  - Extended debug panel controller (`src/ui/debugPanel.js`):
    - new handlers `onResetStorage`, `onToggleDamagePreview`
    - new UI setter `setDamagePreviewOnly(enabled)`
  - Extended app state (`src/state/appState.js`) with `debugPlayerDamagePreviewOnly` and preserved it across dungeon/error transitions.
  - Integrated in main loop (`src/main.js`):
    - added storage reset flow (`resetStorageAndReload`) that clears localStorage and regenerates current seed
    - added damage-preview toggle flow with UI/state sync
    - debug stats now include `被ダメ設定` line and update digest reflects preview mode
    - wired enemy attack call to pass `{ applyPlayerHpDamage: appState.debugPlayerDamagePreviewOnly !== true }`
  - Enemy attack system update (`src/enemy/enemySystem.js`):
    - `updateEnemyAttacks(..., options)` now supports `applyPlayerHpDamage=false`
    - when disabled, HP is not reduced while hit flash + damage popup event remain active (演出のみ)
- 2026-02-11: Added/updated tests for debug options.
  - Updated `tests/unit/debugPanel.test.js`:
    - onResetStorage callback invocation
    - onToggleDamagePreview callback invocation
    - `setDamagePreviewOnly` label/aria switching
  - Updated `tests/unit/appState.test.js` for `debugPlayerDamagePreviewOnly` default/persistence/reset behavior.
  - Updated `tests/unit/enemySystem.test.js` with preview-only mode case (events+flash on, HP unchanged).
- 2026-02-11: Validation complete after debug option integration:
  - `npm run unit` -> PASS (11 files, 63 tests)
  - `npm run test:checks` -> PASS
- 2026-02-11: Fixed enemy telegraph rendering shape in `src/render/canvasRenderer.js` by replacing rectangle-style overlay with sprite-silhouette tint rendering (`drawTintedFrame` via offscreen `source-in`), preserving draw order (base -> red telegraph -> white flash).
- 2026-02-11: Revalidated after telegraph shape fix:
  - `npm run unit` -> PASS (11 files, 63 tests)
  - `npm run test:checks` -> PASS (generation/enemy walk/fly/notice-giveup/enemy-attack/player-attack)
  - Playwright skill-client run with `tests/actions/enemy_notice_giveup.json` captured artifacts at `output/web-game-enemy-telegraph-shape` (no console error artifacts).
- 2026-02-11: Implemented enemy range-control v1.2 (`preferred/engage/retreat`) with minimal behavior changes.
  - AI profile validation (`src/enemy/enemyAiProfileDb.js`): explicit non-negative checks for `preferred_range_tiles`, `engage_range_tiles`, `retreat_range_tiles`.
  - Enemy attack profile build (`src/main.js`): added `preferredRangePx`, `engageRangePx`, `retreatRangePx` from AI profile tiles.
  - Enemy runtime (`src/enemy/enemySystem.js`): added `preferredRangePx`, `engageRangePx`, `retreatRangePx`, `rangeMoveTargetPx`, `rangeIntent` and runtime-safe range normalization (`engage=max(engage,retreat)`).
  - Chase movement now uses distance band intent (`approach` / `hold` / `retreat` / `legacy_chase`) while preserving existing walk/fly passability handling.
  - Attack gate updated: windup start requires `distance <= engageRangePx` when engage range is configured; existing active-range + LOS checks preserved.
  - Text state extended (`src/main.js` / `render_game_to_text`): `distanceToPlayerPx`, range fields, and `rangeIntent` per enemy.
- 2026-02-11: Added/updated tests for range-control v1.2.
  - `tests/unit/enemyAiProfileDb.test.js`: normalization checks for range fields + negative value rejection.
  - `tests/unit/enemySystem.test.js`: approach/hold/retreat behavior, retreat>engage runtime normalization, engage-gated attack start.
  - `scripts/check_enemy_attack.mjs`: added engage-range gate scenario before windup.
- 2026-02-11: Validation complete for range-control v1.2:
  - `npm run unit` -> PASS (11 files, 67 tests)
  - `npm run test:checks` -> PASS
  - Playwright skill-client run (`tests/actions/enemy_notice_giveup.json`) -> artifacts at `output/web-game-range-v12`; `state-0.json` includes new range debug fields and no `errors-*.json` artifact.
- 2026-02-11: Changed default player-damage debug mode to preview-only (HP not reduced by default).
  - `src/state/appState.js`: `debugPlayerDamagePreviewOnly` default/fallback switched to `true`.
  - `index.html`: `#damage-preview-toggle` initial label/pressed-state set to preview-only (`被ダメ無効(演出のみ)`, `aria-pressed=true`).
  - `tests/unit/appState.test.js`: updated expected default/error-state values to `debugPlayerDamagePreviewOnly: true`.
- 2026-02-11: Validation after default toggle change:
  - `npm run unit` -> PASS (11 files, 67 tests)
