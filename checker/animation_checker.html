<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Walk Animation Preview</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .label { font-weight: 700; margin-bottom: 8px; }
    canvas {
      width: 256px;  /* 表示倍率（64pxの4倍） */
      height: 256px;
      border: 1px solid #999;
      border-radius: 6px;
      background: repeating-conic-gradient(#f3f3f3 0% 25%, #ffffff 0% 50%) 50% / 20px 20px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    input[type="range"] { width: 220px; }
    .hint { color: #555; font-size: 12px; margin-top: 10px; line-height: 1.5; }
  </style>
</head>
<body>
  <h1 style="margin:0 0 8px;">歩行アニメ確認</h1>

  <div class="controls">
    <label>スプライトシート:
      <input id="file" type="file" accept="image/png" />
    </label>

    <label>速度(ms/コマ):
      <input id="speed" type="range" min="60" max="260" step="10" value="130" />
      <span id="speedText">130</span>
    </label>

    <label>表示倍率:
      <select id="scale">
        <option value="2">2x</option>
        <option value="3">3x</option>
        <option value="4" selected>4x</option>
        <option value="5">5x</option>
      </select>
    </label>
  </div>

  <div class="row" id="grid">
    <div class="card">
      <div class="label">前（下移動 / DOWN）</div>
      <canvas id="c_down" width="64" height="64"></canvas>
    </div>
    <div class="card">
      <div class="label">左（LEFT）</div>
      <canvas id="c_left" width="64" height="64"></canvas>
    </div>
    <div class="card">
      <div class="label">右（RIGHT）</div>
      <canvas id="c_right" width="64" height="64"></canvas>
    </div>
    <div class="card">
      <div class="label">後ろ（上移動 / UP）</div>
      <canvas id="c_up" width="64" height="64"></canvas>
    </div>
  </div>

  <div class="hint">
    ・デフォルトは同フォルダの <b>buta_walk_spritesheet_64x64_4dir_3frame.png</b> を読み込みます（名前が違う場合は下のJSのパスを変更）。<br/>
    ・スプライトシート想定：<b>横3コマ × 縦4方向</b>（1コマ64×64）／行は <b>下(前), 左, 右, 上(後ろ)</b>。<br/>
    ・再生順は <b>A→B→C→B</b> のループです（よくある3コマ歩行）。
  </div>

  <script>
    // ====== 設定 ======
    const FRAME_W = 64;
    const FRAME_H = 64;
    const COLS = 3;

    // 同フォルダに置く場合（必要ならファイル名を変更）
    const SPRITESHEET_SRC = "buta_walk_spritesheet_64x64_4dir_3frame.png";

    // 行（0始まり）：下(前), 左, 右, 上(後ろ)
    const DIR_ROW = { down: 0, left: 1, right: 2, up: 3 };

    // 3コマ歩行の定番：0→1→2→1→...
    const FRAME_ORDER = [0, 1, 2, 1];

    // ====== 参照 ======
    const canvases = {
      down: document.getElementById("c_down"),
      left: document.getElementById("c_left"),
      right: document.getElementById("c_right"),
      up: document.getElementById("c_up"),
    };

    const ctxs = Object.fromEntries(Object.entries(canvases).map(([k, c]) => {
      const ctx = c.getContext("2d");
      ctx.imageSmoothingEnabled = false;
      return [k, ctx];
    }));

    const fileInput = document.getElementById("file");
    const speedInput = document.getElementById("speed");
    const speedText  = document.getElementById("speedText");
    const scaleSel   = document.getElementById("scale");

    // ====== 状態 ======
    const img = new Image();
    img.decoding = "async";
    img.onload = () => start();
    img.onerror = () => {
      console.warn("スプライトシートを読み込めませんでした。ファイル選択で指定してください。");
    };

    let timer = null;
    let step = 0;

    function applyScale() {
      const s = Number(scaleSel.value);
      for (const c of Object.values(canvases)) {
        c.style.width = (FRAME_W * s) + "px";
        c.style.height = (FRAME_H * s) + "px";
      }
    }

    function draw() {
      const col = FRAME_ORDER[step];

      for (const [dir, row] of Object.entries(DIR_ROW)) {
        const sx = col * FRAME_W;
        const sy = row * FRAME_H;

        const ctx = ctxs[dir];
        ctx.clearRect(0, 0, FRAME_W, FRAME_H);
        ctx.drawImage(
          img,
          sx, sy, FRAME_W, FRAME_H,
          0, 0, FRAME_W, FRAME_H
        );
      }
    }

    function start() {
      stop();
      step = 0;
      draw();

      const ms = Number(speedInput.value);
      timer = setInterval(() => {
        step = (step + 1) % FRAME_ORDER.length;
        draw();
      }, ms);
    }

    function stop() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    // ====== UIイベント ======
    speedInput.addEventListener("input", () => {
      speedText.textContent = speedInput.value;
    });

    speedInput.addEventListener("change", () => start());

    scaleSel.addEventListener("change", () => applyScale());

    fileInput.addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      img.src = url;
    });

    // 初期設定
    applyScale();
    speedText.textContent = speedInput.value;
    img.src = SPRITESHEET_SRC;
  </script>
</body>
</html>
