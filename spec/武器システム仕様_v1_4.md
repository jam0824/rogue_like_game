# 武器システム仕様 v1.4

本ドキュメントは、ゲーム全体仕様「ゲーム概要_v2.md」から**武器に関する仕様を切り出し**、武器・スキルチップ・武器軌道（フォーメーション）・属性/状態異常/相性（リアクション）を中心にまとめたもの。

- 参照: ゲーム概要_v2.md / ステータス仕様_v1_3.md（状態異常・ダメージ計算・派生値）

- 更新（v1.4）：フォーメーション定義（Config/JSON）に `tags` / `ui.icon_file_name` / `ui.sort_order` / `clamp` / `params` を明記し、距離単位はタイル固定（`units` を持たない）に統一。
- 更新（v1.4）：武器データの `weapon_file_name` 表記を統一（誤記修正）。


---

## 1. 用語

- **武器枠**：プレイヤーが装備できる武器スロット。武器枠ごとに攻撃周期（クールダウン）を持つ。
- **武器オブジェクト**：画面上で実際に動き、敵に当たって攻撃判定を出す「剣など」の実体。
- **スキルチップ**：武器に装着する強化・効果付与パーツ。パッシブ/攻撃/軌道/複製/相性強化などを含む。
- **フォーメーション**：武器オブジェクトの動き（軌道）の種類。スキルチップとは別枠の特性。
- **軌道パラメータ**：回転半径・速度・位相ずれなど、フォーメーションを数値的に改造する要素。
- **タグ（tags）**：データ分類用の文字列配列。抽選/出現制御、UIのフィルタ、デバッグに使う。
- **sort_order**：一覧表示順を決める整数（小さいほど先に表示）。主にUI用。
- **icon_file_name**：アイコン画像のファイル名。主にUI用。
- **属性**：攻撃効果のカテゴリ（炎・氷など）。相性（リアクション）の入力になる。
- **状態異常**：敵に付与される継続効果（燃焼・中毒など）。相性（リアクション）の条件になる。
- **リアクション（相性）**：属性/状態の組み合わせで発生する追加効果（爆燃・脆化など）。

---

## 2. 武器の基本仕様

### 2.1 入手と所持
- ダンジョンで武器を拾うことができる。
- 初期武器所持数（＝武器枠数）は **1**。
- 武器は最大 **8本**まで持てる（武器枠最大数）。
- 特定階到達で、地上施設のショップにより武器枠を増やせる。

### 2.2 武器データ構造（最低限）
武器は以下を持つ（= **現在装備している状態をそのまま保持**する）。

#### 必須フィールド（v1）
- **name_key** : 名前のキー
- **description_key** : 説明のキー
- **weapon_file_name** : 武器画像のファイル名（またはパス）
- **width** : 武器画像の幅
- **height** : 武器画像の高さ
- **rarity**：レアリティ（ドロップ/生成のランク）
- **weapon_plus**：武器強化+（精錬で上がる。`0`〜`99`）
- **base_damage**：基礎攻撃力（ダメージ計算の起点。`WeaponBaseDamage` 相当）
- **attack_cooldown_sec**：攻撃周期（クールダウン）
- **hit_num**：ヒット回数（同一敵への多段の総回数。通常 `1`）
- **pierce_count**：貫通回数（同一攻撃で追加で当てられる敵数。通常 `0`）
- **chip_slot_count**：スキルチップスロット数（武器の伸びしろ）
- **formation_id**：フォーメーションID（武器の軌道）
- **skills[]**：スキルチップ配列（ドロップ時点で **全スロット埋まっている**）


例：
```json
{
  "name_key": "name_wepon_sword_01",
  "description_key": "description_wepon_sword_01",
  "weapon_file_name": "wepon_sword_01.png",
  "width": 32,
  "height": 32,
  "rarity": "rare",
  "weapon_plus": 0,
  "base_damage": 12,
  "attack_cooldown_sec": 0.60,
  "hit_num": 1,
  "pierce_count": 0,
  "chip_slot_count": 2,
  "formation_id": "formation_id_circle01",
  "skills": [
    {"id": "skill_id_fire01", "plus": 0},
    {"id": "skill_id_poison01", "plus": 3}
  ]
}
```

※属性（物理/炎など）や状態付与は **skills[] 側（スキルチップ）で表現**し、武器に「初期属性タグ」は持たせない。

---

## 3. 攻撃とヒット判定

### 3.1 自動攻撃
- キャラクターに攻撃モーションは無い。
- プレイヤーの周囲に武器オブジェクトが浮遊し、**自動で動いて敵を攻撃**する。
- 攻撃入力は不要で、武器ごとの攻撃周期で常時攻撃が行われる。

### 3.2 同時発動ルール
- 武器に複数の属性・攻撃スキルが載っている場合、**攻撃時に全て同時に発動**する。
- 軌道チップ・複製チップもスキルとして扱い、装着中は常時効果を持つ。

### 3.3 ヒット回数（hit_num：同一敵への多段）
- **hit_num** は「1回の攻撃（= クールダウン1回ぶん）で、同一敵に与えるヒット数」。通常は **1**。
- **多段は回数で表現**する。

#### 実装ルール（v1推奨）
- 武器枠ごとに `attack_seq`（攻撃シーケンス）を持ち、クールダウンが回るたびに `attack_seq++`。
- 武器オブジェクトは、`attack_seq` ごとに「この攻撃で既に当てた敵IDの集合（hit_set）」を持つ（`attack_seq` が変わったらクリア）。
- 武器オブジェクトが敵に当たったとき：
  - `hit_set` に未登録の敵なら、**ダメージ処理を hit_num 回**行い、敵IDを `hit_set` に追加する。
  - `hit_set` に登録済みなら、その `attack_seq` 中は追加ヒットしない。

※これにより「同一敵への多段」は `hit_num` で表現しつつ、フレーム毎の連続ヒットを防げる。

### 3.4 貫通（pierce_count：同一攻撃で当てられる敵数）
- **pierce_count** は「1回の攻撃（= `attack_seq` 1回）で、**追加で当てられる敵数**」。
  - `pierce_count = 0` → 最大 **1体** に当たる
  - `pierce_count = 2` → 最大 **3体** に当たる（= 1 + 2）
- “雑魚処理の強さ”を作るための定番ノブ。軌道/当たり判定が強い武器ほど、ここを低めにすると暴れにくい。

#### 実装ルール（v1推奨）
- 1武器オブジェクトは、`attack_seq` ごとに **最大命中数**を持つ：
  - `max_targets = 1 + pierce_count`
- `hit_set` のサイズが `max_targets` に達したら、その `attack_seq` 中は **新しい敵への命中を無効**にする  
  （`hit_set` 登録済みの敵への再ヒットは 3.3 のルールで既に無効）

※これにより「当たり判定が密集してる武器が、1回のクールダウンで無限に敵を削る」を防げる。

---

## 4. 武器軌道システム（フォーメーション）

### 4.1 フォーメーションの位置づけ
- 各武器は「フォーメーション」を1つ持つ。
- フォーメーションはスキルチップとは**別枠**（ビルドの別レイヤー）。
- フォーメーションにより、カバー範囲・得意距離・戦術が変わる。

### 4.2 フォーメーション一覧（v1 確定）

#### 命名規則
- `formation_id_<type><nn>`（例：`formation_id_circle01`）
- `nn` は調整違い（半径/速度/角度など）のバリアント用に予約（v1では原則 `01` のみ運用）

#### フォーメーション定義（Config/JSON）
フォーメーションは武器が参照する「武器軌道Config」。定義は **挙動パラメータ** と **UI/運用メタデータ** を分けて持つ。

- 距離/大きさに関する値は **全てタイル単位**（`units` フィールドは持たない）
- `type` ごとに `params` を持ち、共通パラメータはトップレベルに置く
- `ui` は表示/管理用のメタデータで、戦闘挙動には影響しない

**共通フィールド（v1）**
- `id`：フォーメーションID（命名規則は下記）
- `type`：`circle | arc | line | figure8 | spiral | wallbounce`
- `name_key` / `description_key`：表示テキストのキー
- `tags[]`：分類ラベル（抽選/フィルタ/デバッグ用途）
- `radius_base`：基礎半径（軌道チップで増減）
- `angular_speed_base`：基礎回転速度（軌道チップで増減）
- `phase_style`：複数本の位相の割り当て（基本は等間隔）
- `bias_strength_mul / bias_response_mul`：クリック方向バイアスの“効き”倍率（TEC由来の BiasStrength/BiasResponse に掛ける）

**追加フィールド（推奨）**
- `clamp`：チップ等で改造した後の安全柵（暴れ防止）
  - `radius_min/max`, `speed_min/max`, `bias_offset_ratio_max`
- `ui`
  - `icon_file_name`：アイコン画像ファイル名（例：`formation_circle01.png`）
  - `sort_order`：一覧表示順（小さいほど先）

**type別 params（v1の最低限）**
- `circle`：`center_mode`（`player` / `biased_center`）
- `arc`：`arc_deg`, `arc_dir`（`front` / `back`）, `center_offset_enable`
- `line`：`line_len`, `motion`（`pingpong`）, `side_spacing`
- `figure8`：`a`, `b`, `omega_mul`
- `spiral`：`r_min`, `r_max`, `radial_omega`
- `wallbounce`：`speed`, `bounce_damp`, `turn_to_bias_strength`, `lifetime_sec`（※ストレッチ）

例（circle）：
```json
{
  "id": "formation_id_circle01",
  "type": "circle",
  "name_key": "formation_name_circle",
  "description_key": "formation_desc_circle",
  "tags": ["starter", "stable"],

  "radius_base": 2.2,
  "angular_speed_base": 3.0,
  "phase_style": "even",

  "bias_strength_mul": 1.1,
  "bias_response_mul": 1.0,

  "clamp": {
    "radius_min": 1.0,
    "radius_max": 4.5,
    "speed_min": 0.5,
    "speed_max": 8.0,
    "bias_offset_ratio_max": 0.6
  },

  "params": {
    "center_mode": "biased_center"
  },

  "ui": {
    "icon_file_name": "formation_circle01.png",
    "sort_order": 10
  }
}
```

> BiasStrength/BiasResponse の計算は「ステータス仕様_v1_3.md（3.8）」を参照。

#### v1 コア（実装容易・まずこれで回す）
| formation_id | 名称 | 概要 | 得意 |
|---|---|---|---|
| formation_id_circle01 | 円周リング | プレイヤー周囲を360°で回転 | 安定した周囲制圧／初心者向け |
| formation_id_arc_front01 | 前方扇形 | クリック方向（前方）に扇形で集中 | “前から押す”／単体〜中集団 |
| formation_id_arc_back01 | 後方護衛 | クリック方向の反対（後方）に扇形で集中 | “逃げ撃ち”／背面ケア |
| formation_id_line_front01 | 前方ライン（突き） | 前方へ伸びて戻る往復ライン | 狙い撃ち／細い通路で強い |
| formation_id_figure801 | 8の字 | 前後を往復する∞軌道 | 前後対応／隙が周期的に生まれる |
| formation_id_spiral01 | スパイラル | 半径が内⇄外へ周期変化しながら周回 | リーチ確保／外周ヒットを作る |

#### v1.1 ストレッチ（地形依存・後回しOK）
| formation_id | 名称 | 概要 | 備考 |
|---|---|---|---|
| formation_id_wallbounce01 | 壁沿いバウンド | 壁に当たると反射しながら移動 | 壁判定/反射が必要。実装が重い場合は後回し |

---

### 4.2.1 各フォーメーションの“当たり方”とバイアス（クリック方向）の適用

ここでは「クリック方向＝移動方向ベクトル」を `aim_dir` として、武器軌道に反映する。

- `aim_dir`：プレイヤーからクリック位置への正規化方向
- `bias_dir`：`aim_dir` を BiasResponse で平滑化した方向（急なブレを抑える）
- `bias_offset`：`BiasStrength` により決まる、中心/密度の最大オフセット（半径に対して割合で clamp 推奨）

**circle01（円周リング）**
- 位置：`center = player + bias_dir * bias_offset`
- 軌道：`pos = center + rot(angle) * radius`
- 体感：クリック方向へ“輪”がずれる＝密度操作が分かりやすい

**arc_front01（前方扇形）**
- 位置：`center = player + bias_dir * bias_offset`（or 0でも可）
- 角度：`arc_center = bias_dir`、`arc_deg`（固定値：例120°）
- 軌道：扇形上を周回（複数本は位相で分散）
- 体感：押し込み／正面処理が強い（後ろは薄い）

**arc_back01（後方護衛）**
- `arc_center = -bias_dir`（後方）
- 体感：撤退・ kite がしやすい（前方は薄い）

**line_front01（前方ライン）**
- 軌道：`pos = player + bias_dir * (line_len * pingpong(t)) + side_offset`
  - `pingpong(t)`：0→1→0 の往復（クールダウン周期とは独立でOK）
- 体感：クリック方向へ“刺す”。狭い通路やボスに強い
- 注意：密度が強すぎると単体火力が跳ねやすいので `pierce_count` を低めにしやすい

**figure801（8の字）**
- 軌道：∞（レムニスケート）を `bias_dir` 方向に向ける
  - 例：ローカル座標で `(x, y) = (sin(ωt), sin(2ωt)/2) * radius` を `bias_dir` 基準に回転
- 体感：前後を周期的にカバー（“空白時間”ができるのが個性）

**spiral01（スパイラル）**
- 半径：`r = lerp(r_min, r_max, (sin(ωt)+1)/2)`（内⇄外）
- 角度：周回（`angular_speed_base`）
- 体感：外周で当てる/内周で守るを作れる（密度操作も乗る）

**wallbounce01（壁沿いバウンド）**（ストレッチ）
- `vel` を持つ移動体として扱い、壁（またはコリジョン）で反射
- クリック方向は初期速度やターン制御に使う（例：一定時間ごとに `vel` を `bias_dir` へ寄せる）
- 体感：地形で強さが変わる“尖り”枠

---

### 4.3 クリック方向の意味付け（重心移動）
> 重心偏り（BiasStrength）・追従速度（BiasResponse）に対するTECの影響は **「ステータス仕様_v1_3.md」** を参照。

- プレイヤーはマウスクリック方向へ移動する。
- クリック方向ベクトルに応じて、武器軌道の**重心（中心/密度）が偏る**。
  - 攻撃寄り：前方に偏る（前方扇形などが強化される）
  - 防御寄り：後方に偏る（後方護衛などが強化される）
- 操作（移動）そのものが戦術になる。

---

## 5. 軌道パラメータと軌道チップ

### 5.1 代表的な軌道パラメータ
- **回転半径**：武器が回る距離
- **回転速度**：武器が回る速さ
- **位相ずれ**：複数本の配置間隔（密集/拡散）
- **貫通回数**：敵を貫く回数
- （攻撃）**ヒット回数（hit_num）**：同一敵への多段（通常1）

### 5.2 軌道チップ（例）
- 回転半径+
- 回転速度+
- 位相ずれ+（密集/拡散の方向性をチップで分けてもよい）
- 貫通回数+
- ヒット回数+（多段化）

### 5.3 体感の指針（見た目変化を重視）
- 数値上昇は、可能な限り**視覚的変化**（密度・広がり・残像など）を伴う。
- 本数増加（複製）と位相ずれは特に「増えた感」が出るため優先的に演出を入れる。

---

## 6. 本数増加（複製チップ）

### 6.1 目的
- 武器1本につき n 本へ増やし、見た目の爽快感と面制圧力を上げる。
- ただし無制限のDPS増加を防ぐため、ルールで抑制する。

### 6.2 仕様
- 「複製」スキルチップを装着すると、その武器枠から生成される武器オブジェクト本数が増える。
- **1武器につき複製チップは1枚のみ装着可能**
- **複製の+上限は3**
- 生成本数：`n = 1 + 複製の+値`
  - 複製+1 → 2本
  - 複製+2 → 3本
  - 複製+3 → 4本
- 生成された複数本は、位相ずれに応じて配置される。

### 6.3 攻撃周期の共有（複製）
- 同一武器から生成された複数本（複製）は、**同じ攻撃周期（クールダウン）を共有**する（= `attack_seq` も同時に進む）。
- ヒット判定は **各コピーが独立**（同一敵にもそれぞれ当たる）を基本とし、総火力の暴れは **逓減補正（6.4）** で制御する。
  - ※もし単体相手の瞬間火力が強すぎる場合は、調整ノブとして「同一敵は武器枠ごとに1回まで（hit_setを武器枠で共有）」へ切替可能。

### 6.4 本数増加時の逓減補正（推奨初期式）
- 本数増加は総ダメージが逓減補正される。
- 推奨初期式（調整可能）：
  - 総ダメ倍率 `= 1 + 0.6×(n-1)`
  - 1本あたりの係数 `= 総ダメ倍率 / n`
  - 例：
    - 2本：総1.6倍（1本0.8倍）
    - 3本：総2.2倍（1本0.733倍）
    - 4本：総2.8倍（1本0.7倍）

---

## 7. スキルチップ仕様

### 7.1 チップ分類
- **パッシブチップ**：常時発動（攻撃力+%など）
- **攻撃チップ**：攻撃時に発動（属性付与、状態付与、追加弾など）
- **軌道チップ**：軌道パラメータを改造（回転半径+など）
- **複製チップ**：本数増加（複製+）
- **相性強化チップ（任意）**：特定リアクションを伸ばす（例：爆燃の範囲+）

### 7.2 タグ設計（相性の前提）
各チップは最低限以下のタグを持つ。

- **属性タグ**：物理 / 炎 / 氷 / 毒 / 雷
- **付与状態タグ**：燃焼、中毒…など（付与する状態異常）

---

## 8. 属性・状態異常・相性（リアクション）

### 8.1 属性（5種）
- 物理
- 炎
- 氷
- 毒
- 雷  
（将来拡張の6種目は温存）

### 8.2 状態異常（8種）
> スタック付与・減衰・DoT・昇格（凍結/麻痺）・パラメータ表の詳細は **「ステータス仕様_v1_3.md」** を参照。

1. **出血**（物理：DoT、スタック）
2. **中毒**（毒：DoT、スタック）
3. **燃焼**（炎：DoT、スタック）
4. **冷却**（氷：移動/攻撃速度低下、スタック）
5. **凍結**（冷却が閾値で昇格：短時間停止）
6. **感電**（雷：追加ダメ/連鎖の素、スタック）
7. **麻痺**（感電が閾値で昇格：短時間スタン）
8. **脆化**（被ダメ上昇：主に相性で付与）

### 8.3 相性（リアクション）判定手順（同時発動に対応）
> 処理順の詳細・ダメージ計算の順序は **「ステータス仕様_v1_3.md」** を参照。

- 1回の攻撃ティックで複数効果が同時発動することを前提に、以下の順で処理する。
  1. **このティックで付与される状態異常をいったん適用**
  2. **リアクション表をチェックして発生**
- これにより「炎＋毒を同時に当てた」場合でも爆燃が成立する。

### 8.4 リアクション表（初期コア案）
> リアクション発生時の状態消費/解除ルールの詳細は **「ステータス仕様_v1_3.md」** を参照。

※数値は後で調整。まずは「体験の役割」を固定する。

- **毒（中毒）× 氷 → 脆化**
  - 条件：中毒中の敵に氷が当たる（同ティック可）
  - 効果：脆化付与（短時間の火力窓）
  - 消費：中毒スタックを1消費（推奨）
- **炎 × 毒（中毒） → 爆燃**
  - 条件：中毒中の敵に炎（同ティック可）
  - 効果：即時爆発ダメ＋小範囲、燃焼付与
  - 消費：中毒スタックを2〜3消費（推奨）
- **炎 × 氷（冷却/凍結） → 融解**
  - 条件：冷却/凍結中に炎
  - 効果：高倍率単体ダメ（凍結解除＝安全と引き換え）
- **物理 × 氷（凍結） → 破砕**
  - 条件：凍結中に物理
  - 効果：破砕ダメ＋小範囲（凍結解除）
- **雷 × 氷（冷却/凍結） → 破砕導電**
  - 条件：冷却/凍結中に雷
  - 効果：感電を周囲へ拡散、チェイン強化など（集団処理寄り）
- **雷 × 毒（中毒） → 神経毒**
  - 条件：中毒中に雷
  - 効果：感電付与量+／麻痺しやすく（制御寄り）
  - 消費：中毒は消費しない（推奨：代わりに効果量控えめ）

### 8.5 暴れ防止の共通ルール（必須）
- **リアクションは敵ごとにICD（内部クールダウン）**を持つ（例：0.7秒）
- **1ティックにつき同一敵は最大1リアクション**（優先度で決定）
  - 優先度例：爆燃 ＞ 融解 ＞ 破砕導電 ＞ 破砕 ＞ 脆化 ＞ 神経毒

---

## 9. 武器合成

- ダンジョンで武器合成アイテムを拾うことができる。
- 合成時は、ベース武器の **chip_slot_count** 分だけスキルチップを載せることができる。
- 同じスキルを持った武器を合成すると、そのスキルは+になる（毒+1など）。
- +は99まで。
  - 例外：**複製は+上限3**
- 合成時のフォーメーション：
  - ベース武器のフォーメーションを引き継ぐ（フォーメーションは別枠で変更する想定）

---

## 10. 武器の強化（精錬所）

- 精錬所で武器を鍛えることができる。
- 強化すると武器の **weapon_plus** が上がる（`0`〜`99`）。
- **weapon_plus は base_damage にのみ影響**し、`attack_cooldown_sec / chip_slot_count / pierce_count` などの“ビルド領域”は直接触らない（調整を壊しやすいため）。

### 10.1 weapon_plus の効果（推奨：逓減）
- `WeaponBaseDamage_final = base_damage * DamagePlusMult(weapon_plus)`
- 推奨（逓減式：+が大きくても破綻しにくい）：
  - `DamagePlusMult(plus) = 1 + MAX * plus / (plus + HALF)`
  - 初期値（仮）：`MAX = 2.0`, `HALF = 25`
    - 目安：`plus=25` でおよそ **+100%弱**、`plus=99` で **約2.6倍** 付近

※同じ逓減式は状態付与（ApplyMult）でも採用しているため、全体の“+設計”が揃って運用しやすい（詳細は **ステータス仕様_v1_3.md** を参照）。

---

## 11. 武器のロストと再取得

- 死ぬと手持ちのアイテムは全てロストする（ただし護符アイテムを所持していれば1枠だけ持ち帰れる。詳細はゲーム概要_v2.mdを参照）。
- ロストした武器は、死んだ階以降で敵から再度取得できる。
- 再取得した武器のスキルやアップグレード状態は、死んだときのまま維持される。

---

## 12. 他システムとの接続（最小限）

- **テイムしたモンスター**は武器枠扱い（自動攻撃する武器として振る舞う）。
  - モンスターにもスキルを付けられる（チップ適用ルールは武器に準ずる）。
  - HPを持ち、死んだら復活しない（武器とは異なる制約）。

---

## 13. 実装・調整の主なノブ（後で詰める項目）

- 1武器あたりのスキルチップスロット数
- フォーメーションの入手方法（武器固有/チップ/付与アイテム）
- 各状態異常のスタック上限・持続時間・効果量（※v1の初期値は **「ステータス仕様_v1_3.md」** に記載済み）
- リアクションICD・優先度・消費量（※消費/解除ルールは **「ステータス仕様_v1_3.md」** に記載済み）
- 逓減式の係数（0.6部分）と武器別の例外
- クリック方向の重心移動量（攻撃寄り/防御寄りの度合い）
