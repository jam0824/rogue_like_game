# ダンジョン仕様_v1.1

> 本書は「ゲーム概要_v2.md」の**ダンジョン関連記述**をベースに、会話で決定した v1 仕様（フロア生成・宝箱カテゴリ等）を追記してまとめたもの。

- バージョン: v1.1  
- 更新日: 2026-02-13  
- 参照元: ゲーム概要_v2.md / 武器システム仕様_v1_4_1.md（関連） / ステータス仕様_v1_4_3.md（関連）

---

## 1. ダンジョン概要（抜粋 + 追記）

- 本作はローグライトのアクションRPGで、**地下100階**を目指す。  
- ダンジョンは入るたびに形を変える**自動生成ダンジョン**。  
- **死ぬと手持ちのアイテムは全てロスト**する（ただし護符アイテムを所持していれば1枠だけ持ち帰れる。詳細はゲーム概要_v2.mdを参照）。  
- ダンジョンは**フロアごとにオートセーブ**。  
- いつでも一時停止ができる。  
- ダンジョンは**チップタイル**で構成される。
- チップタイルは基本的に32x32である。topの壁など32x160のように例外もある。
- ラン内のLVがある。地上に戻るとレベルは1に戻る。

---

## 2. 階層構造

### 2.1 節目（固定ルール）
- **10階おきにボス**がいる。  
- **5階おきに地上に戻れるポータルアイテム**が手に入る。  

### 2.2 バイオーム（10階区切り）
- 10階区切りに「**遺跡・菌床・機械・氷穴**」など、**タイルと罠の傾向**を変える。  
  - ※具体的な罠種/密度はバイオームごとに調整する（後述）。

---

## 3. ポータル・帰還（固定ルール）

- ポータルを使った階から地上に戻ることができる。  
- 地上からはポータルを使った階に戻ることができる。  
- 過去にポータルを使った階にも戻ることができる。  
- 地上に戻ると**HP最大値はリセット**される（※HP計算式・ラン内ボーナスの扱いは **「ステータス仕様_v1_4_3.md」** を参照）。  
- ラン内のLVは地上に戻るとレベルは1に戻る。

---

## 4. フロア生成仕様（v1）

### 4.1 フロアのスケール（今回決定）
- 1フロアは **「5分もあれば回れる」**程度の大きさにする（広すぎない）。

> 推奨初期値（調整可）
> - 合計 9〜12部屋程度  
> - 開始→階段の主線（クリティカルパス）は 5〜7部屋程度  
> - 枝道は 2〜3本（各 1〜2部屋）  

### 4.2 レイアウト（今回決定）
- 生成方式は **部屋＋通路型**。  
- 必ず **「開始部屋」** と **「階段部屋」** を含む。  
- **枝道 2〜3本 + 小ループ 1つ** を基本構造とする。  
  - 「小ループ」＝回り道で合流する短い迂回路（迷子になりにくい程度）

### 4.3 安全地帯（今回決定）
- **開始部屋は安全地帯**：敵/罠なしで一息つける。

### 4.4 敵配置ルール（v1実装準拠）
- 開始部屋には敵を配置しない。  
- 開始部屋以外の各部屋に敵を1体ずつ配置する（階段部屋を含む）。  
- 敵タイプは enemy_db の定義（walk / fly）から選択する。  

---

## 5. 部屋タイプ（候補 / v1案）

> まだ確定していないため「候補」として定義する（実装のしやすさ優先で追加/削除可）。

- **開始部屋（固定）**：敵/罠なし  
- **階段部屋（固定）**：次階への移動ポイント  
- **通常戦闘部屋**：基本の戦闘  
- **罠部屋**：罠（バイオーム依存）＋戦闘（少量）  
- **宝箱部屋**：宝箱（報酬）を中心に据えた部屋  
- **イベント部屋：倒れた冒険者**：善悪選択イベント  
- **モンスターハウス**：高危険・高報酬（宝箱が多い）

---

## 6. コンテンツ配置テーブル（v1）

### 6.1 1フロアあたりの抽選方針（今回決定）
- **宝箱部屋**：高確率で 1つ  
- **モンスターハウス**：低確率  
- **倒れた冒険者**：中確率（善悪の選択）  
- **罠**：バイオームで種類と密度を変える  

> 推奨初期値（調整可・体感の目安）
> - 宝箱部屋：80〜90%で 1つ（10%で 2つ、0〜5%で 0）  
> - 倒れた冒険者：25〜35%  
> - モンスターハウス：5〜8%  
> - 罠部屋：40〜60%で 1つ（バイオームで上下）

---

## 7. 宝箱仕様（v1 / 今回決定 + 初期案）

### 7.1 宝箱の種類（今回決定）
- **common**：ドロップ 1個  
  - 消費アイテム
- **rare**：ドロップ 2個アイテム出現
  - 1つは消費アイテム確定
  - 合成素材
  - 装備品 (出ても1個)
  - スキルチップ（低確率）
- **legendary**:ドロップ 3個アイテム出現
  - 合成素材
  - 装備品
  - 1個は確定で武器
  - スキルチップ
  
### 7.2 宝箱の中身カテゴリ（今回決定）
- **装備（未鑑定）**
  - 未鑑定武器
  - 未鑑定スキルチップ
- **消耗品**
- **鑑定・呪い対策**
- **通貨・換金アイテム**
- **合成素材**（先行導入）
  - 例：武器合成の触媒/素材、精錬素材など（名称と細分は別途）

### 7.3 未鑑定ルール（今回決定）
- 宝箱から出る **装備系（武器・スキルチップ）は未鑑定**とする。  
- 未鑑定のままでも使用/装備は可能だが、**呪いの可能性**がある（鑑定/解除の価値を担保）。

### 7.4 ドロップ生成ルール（推奨初期値・調整可）

#### 7.4.1 宝箱tierの決定（どの宝箱が出るか）

**宝箱部屋（通常）**：宝箱 1個につき、以下の比率で tier を抽選する（フロアが深いほど上振れしやすい）。

| フロア帯 | common | rare | legendary |
|---|---:|---:|---:|
| 1〜10F | 85% | 14% | 1% |
| 11〜30F | 75% | 22% | 3% |
| 31〜60F | 65% | 30% | 5% |
| 61〜90F | 55% | 37% | 8% |
| 91〜100F | 45% | 43% | 12% |

**Boss報酬（10Fごと）**：原則 **legendary 宝箱を 1個確定**（見た目・達成感の担保）。  
※中身の強さ（装備レアリティ）は **フロア帯**でスケールさせる（後述）。

#### 7.4.2 tier別のドロップスロット（何が何個出るか）

- **common**：`slot1`（1個）
  - `slot1`：消耗品（100%）

- **rare**：`slot1〜2`（2個）
  - `slot1`：消耗品（100%）
  - `slot2`：下表から抽選（装備が出るのは最大1個）

- **legendary**：`slot1〜3`（3個）
  - `slot1`：未鑑定武器（100%）
  - `slot2`：下表から抽選（スキルチップはここが主）
  - `slot3`：下表から抽選（主に素材・鑑定・通貨）

#### 7.4.3 スロット別 抽選テーブル（カテゴリ）

**rare / slot2**
| カテゴリ | 割合（目安） |
|---|---:|
| 合成素材 | 35% |
| 鑑定・呪い対策 | 20% |
| 通貨・換金 | 15% |
| 装備（未鑑定） | 30% |

※「装備（未鑑定）」内訳（目安）：**未鑑定武器 70% / 未鑑定スキルチップ 30%**  
（→ rare宝箱でのスキルチップは「低確率」扱い）

**legendary / slot2**
| カテゴリ | 割合（目安） |
|---|---:|
| 装備（未鑑定スキルチップのみ） | 45% |
| 合成素材 | 25% |
| 鑑定・呪い対策 | 20% |
| 通貨・換金 | 10% |

**legendary / slot3**
| カテゴリ | 割合（目安） |
|---|---:|
| 合成素材 | 35% |
| 鑑定・呪い対策 | 20% |
| 通貨・換金 | 20% |
| 消耗品 | 15% |
| 装備（未鑑定スキルチップのみ） | 10% |

※legendary宝箱は、**武器1個 +（追加で）スキルチップ最大1個**を上限推奨。  
`slot2` か `slot3` でチップが出たら、もう片方でチップが出た場合は **リロール**してチップ以外にする。

#### 7.4.4 装備レアリティのスケール（推奨）

宝箱tier（common/rare/legendary）と、フロア帯に応じて **装備側の rarity（common/rare/legendary）** をバイアスする。  
※ここでの「装備rarity」は WeaponInstance/Chip の rarity を指す。

**rare宝箱から出る装備**
| フロア帯 | common | rare | legendary |
|---|---:|---:|---:|
| 1〜10F | 90% | 10% | 0% |
| 11〜30F | 70% | 28% | 2% |
| 31〜60F | 50% | 42% | 8% |
| 61〜100F | 35% | 50% | 15% |

**legendary宝箱から出る装備（武器/チップ共通）**
| フロア帯 | common | rare | legendary |
|---|---:|---:|---:|
| 1〜10F | 75% | 25% | 0% |
| 11〜30F | 50% | 45% | 5% |
| 31〜60F | 30% | 55% | 15% |
| 61〜100F | 15% | 50% | 35% |

※生成される武器の `weapon_plus` / チップの `plus` は、v1では **原則 0** 推奨（強化は精錬・合成で担保）。
### 7.5 モンスターハウスと宝箱（v1決定）

- モンスターハウスには **宝箱を複数配置**し、「高危険・高報酬」を担保する。

推奨初期値（調整可）：
- 宝箱個数：**3〜5個**
- tier内訳（1個ごと抽選）：
  - common：60%
  - rare：35%
  - legendary：5%
- 追加ルール：**rare 以上を 1個保証**（全commonで終わる事故を防ぐ）


### 7.6 グラフィック
- 宝箱は32x32pxである
- 宝箱のグラフィックは、開いていない宝箱/開いた宝箱が縦に並んでいる
  - 座標(0,0)開いていない宝箱
  - 座標(0,32)開いた宝箱
- common
  - common_treasure_box.png
- rare
  - rare_treasure_box.png
- legendary
  - legendary_treasure_box.png

### 7.7 宝箱から出たアイテムについて
- 宝箱から出たアイテムは、ダンジョンの床に落ちる
- 床に落ちたアイテムはプレイヤーの接触で取得できる（8.ダンジョン内でのアイテム取得より）￥

### 7.8 宝箱インタラクト（v1実装確定）
- 宝箱の配置タイルは room内の walkable から選ぶ（中心優先・最近傍）
- 宝箱タイルは walkable=false とし、プレイヤーと walk敵は通行できない（fly敵は現仕様どおり）
- 宝箱の開封条件は以下を同時に満たすこと
  - クリックしたタイルが宝箱タイルと一致
  - プレイヤー足元タイルと宝箱タイルのマンハッタン距離 <= 1
- 距離判定はクリック押下時点の足元タイルを基準にする（押下中移動による誤開封を防止）
- 開封は1回のみ。開封後は見た目が開状態になり、通行不可状態は維持する
- 宝箱ドロップは「宝箱近傍のwalkableタイル」に配置する
  - 近傍が埋まっている場合は探索半径を拡張して最寄りwalkableへ配置する
  - 全域で配置先が見つからない場合は開封を成立させず、アイテム消失を防ぐ

---

## 8. ダンジョン内でのアイテムの取得
- ダンジョン内で落ちているアイテムは、プレイヤーが接触することで取得できる
- 取得の際は「薬草」などと白い文字（黒で縁取り）がプレイヤーの上に浮かび、しばらく表示後にフェードアウトする
  - language_keyを使用して、多言語対応にする
- 取得したアイテムは道具袋に入る
- 道具袋がいっぱいの場合はアイテムの取得ができない
  - 袋がいっぱいで取得できない、の文言を赤文字（黒で縁取り）がプレイヤーの上に浮かび、しばらく表示後にフェードアウトする
  - language_keyを使用して、多言語対応にする
  - 1回の接触で1回のメッセージのみ。アイテムから離れて再度接触するまでは文言を出さない

### 8.1 床アイテム管理（v1実装確定）
- 床アイテムは `groundItems` を単一の管理配列として扱う
  - 宝箱由来ドロップ（`sourceType: chest_drop`）
  - インベントリDROP由来（`sourceType: inventory_drop`）
- プレイヤー接触で再取得できる（取得成功時は `groundItems` から削除）
- インベントリDROP由来アイテムは、元アイテム情報（iconKey / nameKey 等）を保持し、DB非依存で再取得できる


---

## 9. ダンジョンギミック（抜粋）
- モンスターハウスがある。  
- 罠がある（バイオームで種類/密度を変える）。  

---

## 10. ダンジョンイベント：倒れた冒険者（抜粋）

- ダンジョン内に冒険者が倒れていることがある。  
- 手持ちの薬草や消耗アイテムで助けることができる。  
- 助けるとアイテムをもらえたり、地上のショップが割引される等の恩恵がある。  
- 殺すこともでき、選択肢が現れる。  
  - 殺す選択肢を選ぶとバトルになる。  
  - 勝利で武器を得られるが、悪名度が上がり地上施設の条件が悪化する場合がある。  

---

## 11. 今後の拡張メモ（未決定）
- フォーメーション関連アイテムを宝箱カテゴリに追加するか（レア枠など）
- 罠種/密度テーブル（バイオーム別）
- 部屋タイプ確定（エリート部屋/休憩部屋/店部屋などの追加）
