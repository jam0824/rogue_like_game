# 敵キャラ仕様_v1.6.1

- バージョン: v1.6.1  
- 更新日: 2026-02-10（敵の武器攻撃：テレグラフ後に1サイクルだけ表示→消滅、AI/武器ロードアウトDBはv1.6準拠）  
- 参照: ゲーム概要_v2.md / ダンジョン仕様_v1.md / 武器システム仕様_v1_4_1.md / ステータス仕様_v1_4_2.md / 敵設定.md / enemy_template.json  

---

## 0. スコープ

本書で定義するもの：
- 敵データ（enemy_db）の項目と意味（v1）
- 敵の派生ステータス（HP/攻撃/移動/状態耐性など）の算出式（v1）
- 敵の基本挙動（移動・感知・追跡）と当たり判定（v1実装準拠）
- 敵ランク（Normal / Elite / Boss）の定義・倍率・出現ルール（v1）
- Eliteアフィックス（特殊能力）仕様（v1）
- 敵ロール（8種）の最低セットと、部屋内の出し方テンプレ（v1設計）
- ランク/ロールとRunLevel（XP）の連携（参照）

本書で定義しないもの（TODOに回す）：
- 個別の敵AI（攻撃行動、弾幕、設置、支援など）の詳細実装
- バイオームごとの敵ラインナップ（後工程）

---

## 1. 重要な前提

- 本作はクリック移動 + 武器オブジェクトの自動攻撃が主軸（詳細は武器システム仕様）。
- **現フェーズ（v1実装）**では、敵は「追跡のみ」実装対象（攻撃/接触ダメ/物理衝突は未実装）。  
- **v1.6** から「敵も武器（WeaponDef/WeaponInstance）とフォーメーションを持つ」前提の **DB構造**を追加する（攻撃実装時は武器システム仕様に準拠して流用）。  
  一方、本書には **攻撃実装後を見据えた敵ロール（設計）**も含める。

---

## 2. enemy_db（敵データ）仕様

### 2.1 enemy_dbの目的
- 敵キャラの見た目（チップ画像・サイズ）、移動種別（walk/fly）、感知距離（notice/giveup）を定義する。
- さらに v1.1 から、敵ランク/敵ロール/群れスポーンをデータで表現できるようにする。

### 2.2 必須フィールド（v1）
enemy_template.json をベースとし、最低限以下を必須とする。

- `name_key`（多言語キー）
- `description_key`（多言語キー）
- `type`：`"walk"` / `"fly"`
- `tip_file_name`：スプライトファイル名
- `width`, `height`：画像サイズ（px）
- `notice_distance`：感知距離（タイル単位）
- `giveup_distance`：追跡解除距離（タイル単位）
- 一次ステ（敵側の基礎値）：`vit/for/agi/pow/tec/arc`

### 2.3 v1.1 で追加する推奨フィールド（最小セット）
#### (A) rank（ランク）
- `rank`: `"normal" | "elite" | "boss"`
- 原則、enemy_dbの通常エントリは `normal`。  
  Eliteは「スポーン時にnormal個体をelite化する」運用でも、「Elite用エントリを別に作る」運用でもよい。

#### (B) role（ロール）
- `role`: `"chaser" | "swarm" | "shooter" | "flanker" | "charger" | "brute" | "bomber" | "support"`
- 攻撃未実装の間は参照しなくてもよいが、将来の行動テンプレ切り替えキーとして保持する。

#### (C) spawn（群れスポーン）
- 1部屋に置くのは「敵1体」ではなく「**1スポーン**」として扱う（群れ対応）。
- `spawn`: `{ "min": int, "max": int }`（そのスポーンから出る個体数）

> v1実装（各部屋に1体）の互換のため、未定義なら `{"min":1,"max":1}` とみなす。

### 2.4 追加すると便利な任意フィールド（v1.6更新）
- `tags: string[]`：例 `["minion"]` / `["ranged"]` / `["undead"]`
- `ai_profile_id: string`：AIプロファイル参照ID（推奨）。Role共通AIパラメータや「武器の狙い方（aim）」を切り替える。
- `ai_overrides: object`：AIプロファイル値の差分上書き（任意）。指定されたキーだけを上書きし、未指定はプロファイル値を使う。
- `weapon_loadout_id: string`：敵の武器セット参照ID（推奨）。敵はプレイヤーと同じ **WeaponInstance** フォーマットで武器を持つ（詳細は 2.6 節）。
- `weapon_overrides: object`：武器ロードアウト値の差分上書き（任意）。「その敵だけ武器/フォーメーションを少し変えたい」場合に使う。
- `affix_pool: string[]`：Elite化したときに選ばれうるアフィックスの制限（v1は共通プールでもOK）
- `drop_profile: string`：ドロップ方針の参照キー（v1はランクで決めてもOK）

> 互換メモ：旧フィールド `ai_profile`（文字列）は、v1.6 以降は **`ai_profile_id` に統合**する（`ai_profile` は非推奨）。

### 2.5.1 tags（v1確定）

`tags` は敵に付ける **横断ラベル（補助キー）**。`rank`（格付け）や `role`（行動テンプレ）とは独立して複数付与でき、共通の小ルール（HP/XP/耐性/ドロップ制約など）をまとめて適用するために使う。

#### 適用順（推奨）
派生値（HP/攻撃/移動/状態耐性など）への係数は、以下の順で掛ける：

1. 敵固有の基礎（enemy_dbの `vit/for/...` などから算出）
2. **Floor倍率**（ダンジョン階層によるスケール）
3. **Rank倍率**（Normal/Elite/Boss）
4. **Tag倍率**（本節）
5. Eliteアフィックス（特殊能力）の追加倍率

#### v1で使用するtag（6種）
- `minion`：群れの小型（SWARM向け）
- `ranged`：遠距離系（生成制約用）
- `heavy`：重量級（ノックバック/ひるみ耐性）
- `undead`：不死（出血/毒などの通りにくさ）
- `summoned`：召喚体（XP/ドロップ無効）
- `armored`：装甲（物理ダメージ軽減）

---

#### tag係数（v1確定）

> 値は **最初に動くバランス基準**として確定し、必要が出た場合のみv2で見直す。

| tag | HP | 攻撃 | 移動 | XP | AilmentTakenMult | DurationMult | CC持続 | 追加ルール（概要） |
|---|---:|---:|---:|---:|---:|---:|---:|---|
| `minion` | ×0.60 | ×0.70 | ×1.05 | ×0.60 | ×1.10 | ×1.00 | ×1.00 | ドロップ基本なし（通貨極小） |
| `ranged` | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | 生成制約のみ（下記） |
| `heavy` | ×1.25 | ×1.10 | ×0.90 | ×1.00 | ×0.90 | ×0.95 | ×0.85 | ひるみ/ノックバック耐性（下記） |
| `undead` | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | ×1.00 | 状態付与タイプ別補正（下記） |
| `summoned` | ×1.00 | ×1.00 | ×1.00 | ×0.00 | ×1.00 | ×1.00 | ×1.00 | ドロップ無し・召喚体制約（下記） |
| `armored` | ×1.10 | ×1.00 | ×0.95 | ×1.00 | ×0.95 | ×1.00 | ×1.00 | 物理被ダメ/出血付与補正（下記） |

補足：
- **AilmentTakenMult**：プレイヤーからの状態付与量（apply）に掛かる係数（小さいほど通りにくい）。
- **DurationMult**：`durationPerStack` に掛かる係数（小さいほど維持しにくい）。
- **CC持続**：凍結/麻痺の効果時間に掛かる係数。

---

#### タイプ別補正（v1確定）

**(A) `undead`：状態付与量（apply）倍率**
- 出血：×0.20
- 中毒：×0.50
- 燃焼：×1.00
- 冷却：×1.00
- 感電：×1.00
- 脆化：×1.00

**(B) `armored`：被ダメ/付与補正**
- 物理被ダメ：×0.80（物理のみ軽減。炎/氷/雷は×1.00）
- 出血付与量（apply）：×0.80

---

#### 生成制約・報酬の固定ルール（v1）

**(A) `ranged` 生成制約（推奨）**
- 1部屋における `ranged` タグの敵は最大：
  - 〜30F：2体まで
  - 31F〜：3体まで

**(B) `minion` / `summoned` の報酬**
- `minion`：装備ドロップ無し、通貨は極小、XPは tag表のとおり×0.60
- `summoned`：XP=0、ドロップ無し（完全無効）

**(C) `summoned` の運用（推奨）**
- 召喚体は `tags=["summoned"]` を付ける。
- 同時存在数の上限（例：部屋内最大8体、summoner1体につき最大6体）は別途summoner仕様で定義する。
- 召喚者（summoner）が死亡した場合、召喚体を即時消滅させてもよい（テンポ維持）。

---

### 2.5 enemy_db 例（v1.6：AI/武器参照込み）
```json
{
  "name_key": "name_rabbit",
  "description_key": "description_rabbit",

  "type": "walk",
  "tip_file_name": "rabbit.png",
  "width": 32,
  "height": 32,
  "notice_distance": 8,
  "giveup_distance": 16,

  "rank": "normal",
  "role": "chaser",
  "spawn": { "min": 1, "max": 1 },

  "vit": 10,
  "for": 10,
  "agi": 10,
  "pow": 10,
  "tec": 10,
  "arc": 10,

  "tags": ["minion"],

  "ai_profile_id": "ai_profile_chaser_v1",
  "weapon_loadout_id": "enemy_loadout_rabbit_claw01"
}
```


### 2.6 敵の武器・フォーメーション（v1.6）

敵もプレイヤーと同じ武器データ構造（**WeaponDef / WeaponInstance**）を使って攻撃できるようにする。  
敵固有の値を enemy_db にコピペせず、**参照（正規化）＋差分上書き**で運用する。

---

### 2.6.1 参照（正規化）方針（推奨）

- enemy_db は以下を **ID参照**で持つ：
  - `ai_profile_id`：Role共通AIプロファイル（距離取り/リパス周期/狙い方など）
  - `weapon_loadout_id`：敵の武器セット（WeaponInstance配列）
- 個体差が必要な場合のみ、差分上書きを使う：
  - `ai_overrides`：AIプロファイルの一部キーだけ上書き
  - `weapon_overrides`：武器ロードアウトの一部だけ差し替え

実行時は概ね以下の合成で「解決後の敵（ResolvedEnemy）」を作る。

- `ResolvedEnemy = merge(enemy_db, enemy_ai_profile_db[ai_profile_id], enemy_weapon_loadout_db[weapon_loadout_id])`  
  （overrides があれば、そのキーだけ最終的に上書き）

---

### 2.6.2 enemy_ai_profile_db（Role共通AIプロファイル）

**目的**：Role共通パラメータをまとめ、調整を「1か所」で済ませる。

**必須フィールド（推奨）**
- `id`：AIプロファイルID
- `role`：対象Role（`chaser` など）
- 8.3 節の「Role共通AIパラメータ」一式（デフォルト値あり）

**武器連携（v1.6）**
- `weapon_aim_mode`：敵が `aim_dir` をどう作るか（プレイヤーのクリック方向の代替）
  - `"to_target"`：ターゲット（通常はプレイヤー）への方向
  - `"move_dir"`：敵の移動方向（速度ベクトル）
  - `"none"`：固定（`aim_dir = (0,0)` 扱い。バイアス無し）
- `weapon_visibility_mode`：武器オブジェクトの表示/当たり判定を「攻撃中だけ出す」かどうか
  - `"burst"`：**デフォルト**。windup中は武器を消し、windup終了後に武器を表示して **1サイクルだけ**動かし、以降はクールタイム中に再び消す（詳細は 2.6.6）。
  - `"always"`：武器を常時表示（見た目/圧を出したいBoss等）。攻撃の命中処理は武器の `attack_cooldown_sec`（攻撃周期）に従う。
- （任意）`weapon_attack_cycles`：`weapon_visibility_mode="burst"` のとき、1回の攻撃で回すサイクル数（通常 `1`）
- （任意）`weapon_active_range_tiles`：この距離内のときだけ武器攻撃を有効化（理不尽防止）
- （任意）`weapon_cooldown_mul`：武器側 `attack_cooldown_sec` に掛ける倍率（Role単位のDPS調整用）
- （任意）`los_required`：`true` の場合、射線が通らない相手へは攻撃しない（壁越し射撃の抑制）

例（CHASERのプロファイル）：
```json
{
  "id": "ai_profile_chaser_v1",
  "role": "chaser",

  "preferred_range_tiles": 1.2,
  "engage_range_tiles": 1.0,
  "retreat_range_tiles": 0.0,
  "strafe_chance": 0.05,
  "repath_interval_sec": 0.40,

  "attack_windup_sec": 0.25,
  "recover_sec": 0.35,

  "max_active_hazards": 0,
  "ally_prefer_radius_tiles": 0,

  "weapon_aim_mode": "move_dir",
  "weapon_visibility_mode": "burst",
  "weapon_attack_cycles": 1,
  "weapon_active_range_tiles": 2.0,
  "weapon_cooldown_mul": 1.0,
  "los_required": true
}
```

---

### 2.6.3 enemy_weapon_loadout_db（敵の武器セット）

敵の武器は **プレイヤーと同じ WeaponInstance フォーマット**をそのまま使う。  
（`weapon_def_id` 参照、`skills`、`formation_id` 省略可なども同じ）

**推奨スキーマ**
- `id`：武器ロードアウトID
- `weapons: WeaponInstance[]`：敵が持つ武器インスタンス配列（0〜複数）

**追加フィールド（推奨）**
- `attack_linked: bool`：複数武器を **同じタイムラインで同時に振る**かどうか（デフォルト `true`）
  - `true`：windup/attack/recover を共通化でき、テレグラフが読みやすい（v1推奨）
  - `false`：武器ごとに独立して発動（Boss向け。画面が荒れやすいので慎重に）

例：
```json
{
  "id": "enemy_loadout_rabbit_claw01",
  "attack_linked": true,
  "weapons": [
    {
      "weapon_def_id": "weapon_enemy_claw_01",
      "rarity": "common",
      "weapon_plus": 0,
      "formation_id": "formation_id_enemy_arc_front01",
      "skills": [
        { "id": "skill_id_fire01", "plus": 0 }
      ]
    }
  ]
}
```

---

### 2.6.4 敵用 WeaponDef / Formation の運用（推奨）

- 敵用WeaponDefは、プレイヤーと同じ **WeaponDef** 形式。
  - 運用の混線を避けるため、別DB（例：`db/weapon_def_db_enemy/`）に置くのを推奨。
  - IDは `weapon_enemy_...` のように接頭辞で区別すると安全。
- 敵用Formationも、プレイヤーと同じ **Formation定義** 形式（武器システム仕様のフォーマット）。
  - 別DB（例：`db/formation_db_enemy/`）に分けてもよい。
  - もしくは同DBに置き、`tags: ["enemy_only"]` などでプレイヤーの抽選/入手から除外する運用でもよい。

---

### 2.6.5 aim_dir（クリック方向）の代替（敵）

フォーメーションの `bias` や `arc_front` 等は `aim_dir` を入力として使う（プレイヤーはクリック方向）。  
敵は `weapon_aim_mode` に従って `aim_dir` を作る。

- `to_target`：`aim_dir = normalize(target.pos - enemy.pos)`
- `move_dir`：`aim_dir = normalize(enemy.velocity)`（停止中は直近の移動方向を保持してもよい）
- `none`：`aim_dir = (0,0)`（バイアス無し）

> TEC由来の BiasStrength/BiasResponse を敵にも適用してよい。  
> 「敵はバイアス無しにしたい」場合は、敵側の BiasStrengthBase/BiasResponseBase を 0 相当にして運用する。

---

### 2.6.6 敵武器攻撃の表示・実行ルール（v1.6.1）

敵の武器攻撃は「**テレグラフ → 1サイクルだけ武器を出して動かす → クールタイム中は消す**」を基本とする。

#### 目的
- 画面の常時オブジェクト密度を下げ、**読みやすさ（避けられる）**を担保する
- 攻撃の強さを「予告/頻度/範囲」で調整しやすくする

#### デフォルト挙動（`weapon_visibility_mode="burst"`）

1. **windup（予告）**
   - 時間：`attack_windup_sec`
   - 予告（テレグラフ）を表示する
   - **武器は非表示**（描画しない、当たり判定も無効）
   - 予告の公平性のため、windup開始時に `aim_dir` を確定し（ロック）、attack終了まで更新しない（推奨）

2. **attack（攻撃実行）**
   - windup終了後、武器を **表示**し、当たり判定を **有効化**する
   - 武器はフォーメーションに従って動き、**1サイクル（Δphase=2π）**で終了する
     - サイクル数を変えたい場合は `weapon_attack_cycles` を使う（通常 `1`）
     - 実行時間の目安：`attack_execute_sec ≒ (2π / |ω|) * weapon_attack_cycles`（`ω` は解決後フォーメーションの角速度）
   - サイクル完了後、武器を **非表示**に戻し、当たり判定も無効化する

3. **recover（硬直）**
   - 時間：`recover_sec`
   - 武器は非表示のまま

4. **cooldown（次の攻撃まで）**
   - 武器は非表示のまま
   - 次の攻撃開始タイミングは、武器側の `attack_cooldown_sec` と AI側の `weapon_cooldown_mul` で決める（下記）

#### クールタイム（攻撃周期）の決め方（v1.6.1）

- 1武器の攻撃周期：
  - `weapon_period_sec = ResolvedWeapon.attack_cooldown_sec * weapon_cooldown_mul`
- ロードアウト（複数武器）で `attack_linked=true` の場合（v1推奨）：
  - `weapon_period_sec` の **最大値**を、そのロードアウトの攻撃周期として採用する（最も遅い武器に合わせる）

補足：`attack_windup_sec + attack_execute_sec + recover_sec` が `weapon_period_sec` を超える場合は、超えた分だけ実質的に周期が長くなる（次のwindupは最短でも recover 終了後）。

#### 実行時間（1サイクル）の目安

`angular_speed_base` が小さいと 1サイクルが長くなり、敵攻撃としてはモッサリしやすい。
敵用Formationは、目安として **1サイクルが 0.35〜0.70 秒**程度になるように `angular_speed_base` を設計する（例：`ω ≈ 9〜18 rad/s`）。

#### 例外（`weapon_visibility_mode="always"`）

Bossなど「常時見せたい圧（外周ブレード等）」が必要な場合のみ、武器を常時表示してもよい。
この場合も命中処理は武器の `attack_cooldown_sec`（`attack_seq`）に従う。

---

### 2.7 敵派生ステータス算出（v1確定）

本作の敵は、enemy_db の一次ステ（`vit/for/agi/pow/tec/arc`）から **派生ステータス** を計算し、さらに **Floor / Rank / tag / Affix** で倍率調整する。

#### 出力する派生ステータス（v1最小セット）
- **MaxHP**
- **DamageMult**：与ダメ倍率（POW由来）。武器ダメージ計算の「キャラ倍率」として使う。
- **MoveSpeed**：通常移動速度（`walk_speed` 相当）
- **ChaseSpeed**：追跡速度（`ChaseSpeed = MoveSpeed * 1.3`）
- **CritChance / CritMult**：敵攻撃の将来拡張用（v1では未使用でも保持可）
- **AilmentTakenMult**：状態付与量（apply）に掛かる倍率（小さいほど通りにくい）
- **DurationMult**：状態の `durationPerStack` に掛かる倍率
- **CCDurationMult**：凍結/麻痺の効果時間に掛かる倍率

> 敵が武器を持つ場合、ヒットダメージの基礎は WeaponDef の `base_damage`。
> `HitDamage_preCrit = base_damage * DamageMult * ...` の形で計算し、Floor/Rank/tag/Affix の「攻撃倍率」は**最終ダメージ側**に乗せる。

---

#### 算出順（最終形）
```txt
Base = FromPrimaryStats(vit/for/agi/pow/tec/arc)

// HP / 移動
MaxHP      = Base.MaxHP      * FloorHP(f)  * RankHP(rank)  * TagHP(tags...)  * AffixHP(affix...)
MoveSpeed  = Base.MoveSpeed  * FloorMV(f)  * RankMV(rank)  * TagMV(tags...)  * AffixMV(affix...)
ChaseSpeed = MoveSpeed * 1.3

// 与ダメ（武器を持つ場合）
// HitDamage_preCrit = WeaponDef.base_damage * Base.DamageMult * (1 + ChipDmgPct) * ...
// HitDamage_final   = HitDamage_preCrit * FloorATK(f) * RankATK(rank) * TagATK(tags...) * AffixATK(affix...)

// 状態耐性
AilmentTakenMult = Base.AilmentTakenMult * RankAil(rank) * TagAil(tags...) * AffixAil(affix...)
DurationMult     = Base.DurationMult     * RankAil(rank) * TagAil(tags...) * AffixAil(affix...)
CCDurationMult   = Base.CCDurationMult   * RankCC(rank)  * TagCC(tags...)  * AffixCC(affix...)
```


> `tag` の **タイプ別補正**（例：`armored` の物理被ダメ×0.80、`undead` の出血apply×0.20 など）は、  
> 上の「派生ステータス倍率」とは別に **ダメージ/付与処理のタイミング**で適用する。

---

### 2.7.1 Base（一次ステ → 派生）

> プレイヤー側の「状態異常耐性（逓減）」の形を踏襲する（実装を共通化しやすい）。  
> 敵はテンポを損ねないため、防御（DR）を厚くするより **HP側に寄せる**（FORでHPが伸びる）方針。

```txt
// HP（VIT + FOR）
HP_raw      = E_HP_BASE + vit * E_HP_PER_VIT
ToughMult   = 1 + for * E_HP_PER_FOR
MaxHP_base  = HP_raw * ToughMult

// 与ダメ倍率（POW）
// 武器ダメージ計算は「基礎（WeaponDef.base_damage） * DamageMult」を採用
DamageMult_base = 1 + pow * E_DMG_PER_POW

// 移動（AGI）
MoveSpeed_base = E_MOVE_BASE * (1 + agi * E_MOVE_PER_AGI)
ChaseSpeed     = MoveSpeed_base * 1.3

// クリティカル（TEC）※将来拡張
CritChance = clamp(E_CRIT_BASE + tec * E_CRIT_PER_TEC, 0, E_CRIT_CAP)
CritMult   = clamp(E_CRITDMG_BASE + tec * E_CRITDMG_PER_TEC, 1.0, E_CRITDMG_CAP)

// 状態異常耐性（FOR + ARC：逓減）
AilRes = for * RES_PER_FOR + arc * RES_PER_ARC + RES_FLAT

AilmentTakenMult_fromStats = 1 / (1 + AilRes / K_RES)
AilmentTakenMult_base      = clamp(AilmentTakenMult_fromStats, AILMENT_MULT_MIN, 999)

DurationMult_base    = AilmentTakenMult_base   // v1は統一（必要なら分離）
CCDurationMult_base  = AilmentTakenMult_base   // v1は統一（必要なら分離）
```

---

### 2.7.2 Floorスケール（深層ほど強くする）

Floorは **ダンジョンの階層番号（1始まり）** とする。  
v1は調整しやすい **指数型**を採用（「100Fで何倍」を定数で作れる）。

```txt
FloorHP(f)  = (1 + HP_GROW)^(f-1)
FloorATK(f) = (1 + ATK_GROW)^(f-1)
FloorMV(f)  = (1 + MV_GROW)^(f-1)   // 伸ばすなら超控えめ（任意）
```

適用：
```txt
MaxHP      *= FloorHP(f)
DamageScale *= FloorATK(f)
MoveSpeed  *= FloorMV(f)    // 任意（基本は1.0運用でもOK）
```

推奨初期値（v1）：
- `HP_GROW = 0.022`（100Fで約8.62倍）
- `ATK_GROW = 0.018`（100Fで約5.85倍）
- `MV_GROW = 0.002`（100Fで約1.22倍）

参考倍率（概算）：
- 10F：HP×1.22 / ATK×1.17
- 20F：HP×1.51 / ATK×1.40
- 50F：HP×2.90 / ATK×2.40
- 100F：HP×8.62 / ATK×5.85

---

### 2.7.3 Rank / tag / Affix倍率の合成

- Rank倍率：6.2節の表を掛ける（HP/攻撃/移動/状態耐性/CC持続）。  
- tag倍率：2.5.1節の表を掛ける（同上）。  
- Affix倍率：7.2節（例：**硬い**＝HP×1.4、**呪い体**＝AilmentTakenMult×0.8 など）を掛ける。

---

### 2.7.4 バランス定数（初期値：v1）

> まずは “動く基準値” として確定。数値の微調整はバランス工程で行う。

```txt
// HP
E_HP_BASE     = 30
E_HP_PER_VIT  = 12
E_HP_PER_FOR  = 0.015   // FOR+1でHP×1.5%

// Damage（POW：与ダメ倍率）
E_DMG_PER_POW = 0.02   // POW+1で +2%

// Move
E_MOVE_BASE    = 1.0
E_MOVE_PER_AGI = 0.01    // AGI+1で+1%

// Crit（将来用）
E_CRIT_BASE        = 0.00
E_CRIT_PER_TEC     = 0.001
E_CRIT_CAP         = 0.20
E_CRITDMG_BASE     = 1.50
E_CRITDMG_PER_TEC  = 0.002
E_CRITDMG_CAP      = 2.00

// Ailment Resist（プレイヤー式と同形）
RES_PER_FOR   = 1.0
RES_PER_ARC   = 0.5
RES_FLAT      = 0
K_RES         = 100
AILMENT_MULT_MIN = 0.40  // 最大60%軽減まで（推奨）

// Floor
HP_GROW  = 0.022
ATK_GROW = 0.018
MV_GROW  = 0.002
```

---

## 3. 画像・当たり判定（v1実装準拠）

### 3.1 チップ画像（スプライトシート）
- 1枚のpngに **4行×3列**で歩行アニメを持つ。
- 行：1=下 / 2=左 / 3=右 / 4=上
- 列：A,B,C とし、再生順は `A→B→C→B→A→…` でループ。

### 3.2 壁当たり判定（walk/fly）
- `type=walk`：壁を通り抜けられない（壁当たり判定あり）
- `type=fly`：壁を通り抜けられる（壁当たり判定なし）

#### 高さによる壁当たり判定の例外
- `height >= 64px`：壁当たり判定は **下半分の32×32のみ**（上半分には壁当たり判定なし）
- `height <= 32px`：画像全体が壁当たり判定

### 3.3 攻撃を受ける当たり判定
- プレイヤー攻撃に対する当たり判定は **画像全体**（例：32×64なら32×64全体）

### 3.4 被弾フラッシュ（v1実装）
- 敵は被弾時の視覚フィードバックとして、白フラッシュ用のランタイム値を持つ。
  - `hitFlashTimerSec`（現在の残り時間）
  - `hitFlashDurationSec`（基準時間、既定値 `0.12`）
- ダメージ適用時に `hitFlashTimerSec = hitFlashDurationSec` を設定してフラッシュ開始。
- 毎フレーム `hitFlashTimerSec = max(0, hitFlashTimerSec - dt)` で減衰。
- 描画アルファは `hitFlashAlpha = clamp(hitFlashTimerSec / hitFlashDurationSec, 0, 1)` で算出し、0になったら表示しない。

---

## 4. 感知・追跡・移動（v1実装準拠）

### 4.1 行動状態
- 敵の行動状態は `random_walk` と `chase` の2状態。
- プレイヤーに気づく前：`random_walk`
- プレイヤーに気づいた後：`chase`

### 4.2 感知距離と追跡解除距離
- `notice_distance` / `giveup_distance` は **タイル単位**（1タイル=32px）。
- 挙動安定化のため、追跡解除距離は以下を使用：
  - `giveup_effective = max(giveup_distance, notice_distance)`

### 4.3 追跡（chase）の移動
- `chase_speed = walk_speed * 1.3`（通常移動速度の1.3倍）
- 経路探索なしの直線追従（目標はプレイヤー足元中心）
- `walk` の追従移動は壁判定あり。合成移動できないときは **X/Y単軸フォールバック**を行う。
- `fly` は壁判定なし（壁を通過）。

### 4.4 視線判定（notice）
- `walk`：距離に加えて **視線が通っている**必要がある（壁越しでは気づかない）
- `fly`：視線判定を行わず、距離のみで気づく

### 4.5 距離の定義
- 距離判定は「敵中心」と「プレイヤー足元中心」のユークリッド距離。

---

## 5. 配置（スポーン）ルール

### 5.1 v1実装（現状）
- 開始部屋には配置しない
- 開始部屋以外の各部屋に **1体ずつ**配置する（階段部屋を含む）

### 5.2 v1.1設計（推奨：1部屋=1スポーン）
- 5.1 の実装簡便性を維持しつつ、SWARM/Elite取り巻き対応のため、将来的には
  - 「各部屋に **1スポーン**（階段部屋含む）」  
  - スポーンは `spawn.min/max` の範囲で複数体を生成可能
- 互換：現状実装は `spawn = {min:1,max:1}` とみなせば矛盾なく運用できる。

---

## 6. 敵ランク（Rank）仕様（v1）

### 6.1 Rank一覧
- **Normal**：基本の敵。戦闘の母集団。
- **Elite**：強敵。アフィックスを持ち、報酬/XPが高い。基本は1部屋1体まで。
- **Boss**：10階おきの節目に出る大型敵。CCや状態異常への耐性が高め。

（補助タグ）
- **Minion（タグ）**：取り巻き用。RankはNormalだが「HP低め/よろけやすい」など調整枠。

### 6.2 ランク別の基礎倍率（v1）
> ランク差は HP/攻撃だけでなく「状態異常・CC」の効きにも出す。  
> ただし **完全無効化** は原則しない（ビルドの主役を殺さないため）。

| Rank | HP | 攻撃 | 移動 | 状態付与されやすさ（AilmentTakenMult） | 状態持続（DurationMult） | CC持続（凍結/麻痺） |
|---|---:|---:|---:|---:|---:|---:|
| Normal | ×1.0 | ×1.0 | ×1.0 | ×1.00 | ×1.00 | ×1.00 |
| Elite | ×3.0 | ×1.6 | ×1.1 | ×0.85 | ×0.90 | ×0.80 |
| Boss | ×25.0 | ×2.2 | ×1.0 | ×0.60 | ×0.75 | ×0.50 |

- **AilmentTakenMult**：スタック付与量（apply）に掛ける（Bossはやや効きにくい）
- **DurationMult**：`durationPerStack` に掛ける（維持が強すぎない）
- **CC持続**：凍結/麻痺の効果時間に掛ける（ハメ防止）

### 6.3 CC免疫（連打防止：推奨）
- Normal / Elite：`FreezeImmunity = 3s`, `ParalyzeImmunity = 3s`
- Boss：`FreezeImmunity = 6s`, `ParalyzeImmunity = 6s`

### 6.4 出現ルール
- **Boss**：10階おきに固定出現（10/20/30…）
- **Elite**：
  - 各戦闘部屋に **12%** でElite化（1部屋最大1体）
  - **1フロア上限2体**
  - 生成結果で0体の場合：枝道側の戦闘部屋を1つElite化（見せ場の保証）
  - **v1実装**：Elite化されても取り巻きなし（単体Elite）。配置ルール（5.1節：1部屋1体）に準ずる。
  - **v1.1以降**：出現形式を「Elite 1体 + 取り巻き 2〜6体」に拡張する（5.2節のスポーン仕様と連動）。

---

## 7. Eliteアフィックス（v1）

### 7.1 付与数（深層ほど増える）
- 1〜20F：1個
- 21〜60F：2個
- 61F〜：3個

### 7.2 アフィックス候補（まずは10個で運用）
- **速い**：移動×1.25、突進系の予告が少し短い
- **硬い**：HP×1.4（Rank倍率の上に加算）
- **猛攻**：弾速×1.15、攻撃間隔-10%（敵側のみ）
- **バリア**：一定時間ごとに小シールド（破壊まで被ダメ軽減）
- **反射装甲**：近接ヒット時に小反撃（予告付き）
- **毒雲**：移動跡に短時間の毒床（中毒付与量は低め）
- **炎核**：死亡時に小爆発（予告）
- **冷気**：周囲に冷却オーラ（冷却スタックが溜まる）
- **導電**：近くの敵に感電が伝播しやすい（集団戦の圧）
- **呪い体**：プレイヤーの状態付与が少し通りにくい（AilmentTakenMult×0.8 を追加）

---

## 8. 敵ロール（Role）最低セット（v1設計）

> Rankが「格付け」なのに対し、Roleは「**行動テンプレ（型）**」。  
> クリック移動＋武器重心（密度）操作が活きるように、**「前から押す」「横から刺す」「後ろを作る」「足場を壊す」**を揃える。

### 8.1 Role一覧（8種）
1. **chaser**：追跡近接（基本）
2. **swarm**：群れ（ミニオン）
3. **shooter**：基本遠距離
4. **flanker**：回り込み近接
5. **charger**：突進（予告→ダッシュ→硬直）
6. **brute**：鈍足強打（硬い/重い）
7. **bomber**：設置/範囲（床・爆発）
8. **support**：支援（バフ/回復/召喚のいずれか）

---

### 8.2 Role共通：行動状態（設計）
現フェーズ（v1実装）は `random_walk / chase` の2状態のみ。  
攻撃実装後（次工程）は、Roleごとに以下の“共通骨格”を使ってテンプレ化する。

- **patrol**：部屋内ランダム歩行（現 `random_walk`）
- **chase**：追跡（現 `chase`）
- **engage**：交戦距離に入った後の間合い調整（接近/後退/横移動）
- **windup**：予告（テレグラフ）
- **attack**：攻撃実行
- **recover**：硬直（反撃チャンス）
- **reposition**：位置替え（射線確保/背後取り/危険床回避など）

> 「windup（予告）」と「recover（硬直）」は必須。  
> 事故死より“避けて反撃”の読み合いを優先する。

---

### 8.3 Role共通：AIパラメータ（データ化推奨）

v1.6 以降は enemy_db の `ai_profile_id` から **enemy_ai_profile_db** を参照し、以下のパラメータをまとめて管理する（個体差は `ai_overrides` で差分上書き）。

- `preferred_range_tiles`：理想距離（タイル）
- `engage_range_tiles`：交戦（攻撃開始/圧をかける）距離（タイル）
- `retreat_range_tiles`：近すぎる時に後退を開始する距離（タイル）
- `strafe_chance`：交戦中に横移動する確率
- `repath_interval_sec`：目標点更新周期（ジッター抑制）

- `attack_windup_sec`：予告時間（ロールの“読みやすさ”）
- `recover_sec`：硬直時間（反撃余地）

- `weapon_aim_mode`：武器の `aim_dir` 入力（`to_target | move_dir | none`）
- `weapon_visibility_mode`：武器表示の方針（`burst | always`、デフォルト `burst`。詳細は 2.6.6）
- `weapon_attack_cycles`：`weapon_visibility_mode="burst"` のとき、1回の攻撃で回すサイクル数（通常 `1`）
- `weapon_active_range_tiles`：この距離内のときだけ武器攻撃を有効化（任意）
- `weapon_cooldown_mul`：武器側 `attack_cooldown_sec` に掛ける倍率（任意）
- `los_required`：射線が通らない相手へは攻撃しない（任意）

- `max_active_hazards`：設置上限（BOMBER用）
- `ally_prefer_radius_tiles`：味方との距離（SUPPORT用）

> `attack_cooldown_sec` は **武器側（WeaponDef.attack_cooldown_sec）** に統一する。  
> Role単位でDPSを触りたい場合は `weapon_cooldown_mul` を使う。

---

### 8.4 Role別テンプレ詳細（v1）

以下は「攻撃実装後」を見据えた設計。  
v1（追跡のみ）でも破綻しないよう、各Roleに **移動だけの簡易挙動**も併記する。

---

#### 8.4.1 CHASER（追跡近接）
- **目的**：前から押してプレイヤーを動かす“圧”
- **移動**：最短で接近。障害物がある場合は単軸フォールバックで詰める。
- **攻撃（設計）**：
  - `engage_range_tiles=1.0` で停止→**短い予告（0.25〜0.35s）**→近接スイング
  - スイングは扇形（例：90°）で、正面に重心を合わせると溶かしやすい
  - 攻撃後は `recover_sec=0.25〜0.45s`（反撃余地）
- **v1（追跡のみ）**：常に chase（距離で追跡解除のみ）
- **調整ノブ**：数を増やすと圧が上がる（個体性能よりスポーン数で調整推奨）

---

#### 8.4.2 SWARM（群れミニオン）
- **目的**：範囲・多段・状態付与ビルドの見せ場を作る
- **スポーン**：`spawn.min/max` を多め（例：4〜8）。`tags=["minion"]` 推奨。
- **移動**：群れとして接近しつつ、**個体ごとに小さなオフセット目標**を持たせて“団子化”を防ぐ。
  - `separation_radius`（近づきすぎ防止）を小さく持つと操作感が良い
- **攻撃（設計）**：
  - 低威力・短予告（0.15〜0.25s）で“噛みつき”
  - 1体の圧は低いが、群れで当たると危険
- **v1（追跡のみ）**：群れで chase（オフセット目標は実装できれば先に入れると見栄えが良い）
- **調整ノブ**：HPは低く、数で強さを作る（テンポ優先）

---

#### 8.4.3 SHOOTER（基本遠距離）
- **目的**：位置取りを要求し、背後から削る
- **移動（攻撃実装後）**：
  - `preferred_range_tiles=5〜7`
  - 近すぎる（`retreat_range_tiles=3`）→後退しながら射線確保
  - 遠すぎる（`preferred_range`より大きい）→前進して射程に戻す
  - 射線が通らない→`reposition`（横移動して角を取る）
- **攻撃（設計）**：
  - 直線弾：**予告0.3〜0.5s**（テレグラフは見える形）
  - 狙いは“現在位置”基準（強い先読みはしない）で公平性を担保
- **v1（追跡のみ）**：射程維持のための“後退”だけ先に実装すると良い（撃たないが動きで役割が出る）
- **調整ノブ**：弾速を上げるより、配置/射線で難易度を作る

---

#### 8.4.4 FLANKER（回り込み近接）
- **目的**：武器密度操作を“方向転換”させる主役（横/背後を作る）
- **移動（設計）**：
  - プレイヤー中心の円周上に **フランク目標点**を生成（例：半径3〜5タイル）
  - 左右どちらかの“側面点”を取りに行き、一定周期で目標点を更新（`repath_interval=0.6〜1.0s`）
  - 正面に捕まったら短い後退 or ステップで再度側面へ
- **攻撃（設計）**：
  - 短予告（0.2〜0.3s）の刺し込み
  - 当てたらすぐ離脱（`reposition`）して“張り付きを避ける”
- **v1（追跡のみ）**：円周目標点への移動だけでも“回り込み”が成立する（攻撃なしでも差別化できる）
- **調整ノブ**：フランク半径と更新周期で体感が激変する

---

#### 8.4.5 CHARGER（突進）
- **目的**：事故要員ではなく“避けて反撃”のメリハリを作る
- **発動条件（設計）**：
  - `charge_range_tiles=4〜8`、角度条件（プレイヤー方向への誤差が小さい時）
  - クールダウンが明確（`attack_cooldown=4〜7s`）
- **攻撃（設計）**：
  1) **ライン予告**：`windup=0.6〜0.9s`（方向ロック、明確なテレグラフ）
  2) **ダッシュ**：高速（通常の2.5〜3.5倍）で直進
  3) **硬直**：`recover=0.7〜1.0s`（最大の反撃チャンス）
  - 壁に当たる/外した場合も硬直を発生させ、避け得にする
- **v1（追跡のみ）**：突進が無いので“追跡速度だけ高いchaser”になりやすい。  
  → 先に突進だけ実装する価値が高いRole。
- **調整ノブ**：予告時間と硬直時間は“理不尽さ”に直結するので最優先で調整

---

#### 8.4.6 BRUTE（鈍足強打）
- **目的**：単体火力・状態異常・相性（リアクション）で溶かす相手を作る
- **移動**：遅いが止まらない。近づくほど圧が上がる。
- **攻撃（設計）**：
  - **叩きつけ**：広円AoE（半径2〜3タイル）、`windup=0.7〜1.0s`
  - **衝撃波**（任意）：中距離に低威力直線波（足止め/冷却などと相性）
  - 攻撃後の硬直は長め（`recover=0.8〜1.2s`）
- **v1（追跡のみ）**：鈍足chaserとして成立（HP/当たり判定大きめで差別化）
- **調整ノブ**：攻撃の“範囲”と“予告”で難易度を作り、攻撃頻度は上げすぎない

---

#### 8.4.7 BOMBER（設置/範囲：足場破壊）
- **目的**：クリック移動のルートを壊す（小ループ部屋で面白くなる）
- **移動（設計）**：
  - `preferred_range_tiles=4〜7` を維持（近いと後退）
  - 逃げながら設置しない（理不尽になりやすい）→設置中は基本停止
- **攻撃（設計）**：
  - **着弾予告**のある投擲/設置（地面AoEサークル）
  - 予告 `windup=0.8〜1.2s`、危険床の持続 `hazard_duration=3〜6s`
  - 同時に置ける床の上限：`max_active_hazards=2〜4`（無限に塗りつぶさない）
- **v1（追跡のみ）**：射程維持（近いと離れる）だけでも役割が出る
- **調整ノブ**：床の“滞在時間”と“上限”で難易度が決まる（数を増やすと壊れやすい）

---

#### 8.4.8 SUPPORT（支援）
- **目的**：ターゲット優先順位（倒す順番）を作る
- **サブタイプ**：敵ごとに **どれか1種に固定**（混ぜない）
  - **buffer**：味方強化
  - **healer**：味方回復
  - **summoner**：増援召喚
- **移動（設計）**：
  - プレイヤーから離れつつ、味方の後方に位置（`ally_prefer_radius=3〜6`）
  - 近づかれたら後退（ただし逃げ続けない：部屋端で止まる/短硬直を入れる）
- **支援（設計）**：
  - buffer：最寄りの味方（優先：Elite）へ一定時間バフ（攻撃/移動/シールド等）
  - healer：HPが一定以下の味方へ回復（対象優先：Elite→Normal）
  - summoner：ミニオンを召喚（同時召喚上限あり、例：+6体まで）
  - いずれも `windup=0.6〜1.0s` を持ち、妨害/優先撃破の価値を作る
- **v1（追跡のみ）**：味方後方に位置取る（プレイヤーから離れる）だけでも役割が出る
- **調整ノブ**：支援頻度は低めにし、支援対象の優先順位で“うざさ”を作る

---

### 8.5 部屋内の出し方テンプレ（再掲・v1）
- 小競り合い：`swarm` 多め + `shooter` 少し
- 混成：`chaser` + `shooter` + `flanker`
- 見せ場：`brute` 1 + `swarm` 4〜8
- 回避部屋：`charger` 1〜2 + `shooter`
- 地形部屋：`bomber` 1 + `chaser` 2〜3
- 優先順位部屋：`support` 1 + `chaser` 3 + `shooter` 2

### 8.6 導入順（フロア進行の目安）
- 序盤（〜10F）：`chaser / swarm / shooter`
- 中盤（11〜30F）：`+ flanker / charger`
- 後半（31F〜）：`+ brute / bomber / support`

### 8.7 Elite化の相性（ガイド）
- Eliteは「Roleの個性が強くなる」方向で付加する（理不尽さを避ける）。
  - `charger` Elite：フェイント（ダッシュ方向の微調整）※予告は必ず残す
  - `bomber` Elite：床の種類が2択（毒床＋冷気床など）※上限は維持
  - `support` Elite：対象が増える（単体→周囲2体）※頻度は上げすぎない
- `swarm` をEliteで硬くしすぎるのはテンポ悪化が大きい（基本は取り巻き側へ）。

## 9. XPと報酬（連携）

### 9.1 XP（参照）
敵撃破XPは Rank により基礎値を持つ。  
詳細（FloorMult、RoomClearXP、FloorClearXP、必要XPカーブ）は **「ステータス仕様_v1_4_2.md」** を参照。

### 9.2 ドロップ方針（v1）
> 装備は宝箱が主役。敵ドロップは補助に寄せる。

- **Normal**：通貨/換金が少量（装備ドロップは無し or 超低確率）。敵用スキルアイテムを低確率でドロップ（※ゲーム概要：敵からしか得られないスキルがある）
- **Elite**：合成素材 or 鑑定・呪い対策カテゴリを 1個保証 + 通貨多め（未鑑定チップは低確率）。敵用スキルアイテムを中確率でドロップ
- **Boss**：「あたり宝箱相当」の報酬を確定（強い達成感）。敵用スキルアイテムを高確率でドロップ

---

## 10. TODO（次工程）
- 敵派生ステータスの係数（E_HP_BASE等）のチューニング（バランス工程）
- Roleごとの攻撃テンプレ（弾種、予告、設置、支援）と、行動状態の追加
- バイオーム別ラインナップ（各Role×各バイオームで最低1体ずつ）と、出現重み
- Eliteアフィックスの相性表（Roleごとの禁止/推奨）

---

## 11. 用語集

本書内で出てくる、略語や実装寄りの言葉の簡易説明。

### 11.1 戦闘・効果

- **DPS**：*Damage Per Second*（1秒あたりのダメージ量）。`attack_cooldown_sec`（攻撃間隔）を短くすると、概ねDPSが上がる。
- **AoE**：*Area of Effect*（範囲効果）。円/扇形/線など「当たる範囲」を持つ攻撃。
- **CC**：*Crowd Control*（行動阻害）。本作では主に **凍結**・**麻痺**などの停止/スタン系を指す。
- **テレグラフ**：攻撃の**予告表示/予備動作**のこと（避けて反撃できる設計の核）。
- **windup**：テレグラフの時間（予告時間）。
- **recover**：攻撃後の硬直時間（反撃のチャンス）。
- **ひるみ**：被弾時に一瞬動きが止まる/のけぞる挙動（小さなCC）。
- **ノックバック**：被弾で押し出される挙動。

### 11.2 状態異常（Ailment）まわり

- **Ailment（状態異常）**：出血/中毒/燃焼/冷却/感電/脆化などの総称。
- **apply（付与量）**：状態異常を付ける“量”。本作は端数を貯めて `1.0` で **1スタック**増える方式を想定。
- **AilmentTakenMult**：状態異常が「どれだけ通るか」の倍率。  
  - `×0.60` なら付与量が60%になり、効きにくい。  
  - `×1.10` なら付与量が110%になり、効きやすい。
- **DurationMult**：状態異常の持続（`durationPerStack`）に掛かる倍率。小さいほど維持しにくい。
- **CC持続**：凍結/麻痺などのCC効果時間に掛かる倍率。

### 11.3 敵の分類（Rank / Role / tag）

- **Rank**：敵の格付け（Normal / Elite / Boss）。HP/攻撃/状態耐性などの倍率が変わる。
- **Role**：敵の行動テンプレ（chaser/shooter など）。「どう動く敵か」を表す。
- **tag**：横断ラベル（補助キー）。種族/性質/生成制約/報酬制約など、共通の小ルールをまとめて適用するために使う。
- **Eliteアフィックス（Affix）**：Eliteに付く特殊能力（バリア、毒雲など）。Roleの個性を強める方向で付与する。
- **Minion**：群れ用の小型（`tags=["minion"]` を推奨）。1体は弱いが数で圧を作る。

### 11.4 データ・距離・スポーン

- **enemy_db**：敵キャラの定義データ（JSON）。見た目/移動/感知距離/ステータス/Rank/Role/tag/spawn などを持つ。
- **Spawn（スポーン）**：部屋に配置する“生成単位”。`spawn.min/max` の範囲で複数体を一度に出せる（群れ対応）。
- **tile（タイル）**：距離の単位。`notice_distance` などは **タイル単位**で、基本 `1タイル=32px` を想定。
- **notice_distance**：感知距離（プレイヤーを見つける距離）。
- **giveup_distance**：追跡解除距離（離れたら追跡をやめる距離）。
- **giveup_effective**：`max(giveup_distance, notice_distance)`（挙動安定化のための実効追跡解除距離）。

### 11.5 AI（行動状態・距離取り）

- **random_walk / chase**：現フェーズ（v1実装）の敵行動状態。  
  - `random_walk`：部屋内をランダム移動  
  - `chase`：プレイヤー追跡
- **preferred_range_tiles**：理想距離（この距離に保とうとする）。
- **engage_range_tiles**：攻撃を開始する距離。
- **retreat_range_tiles**：近すぎる時に後退を開始する距離。
- **strafe**：交戦中の横移動（射線確保・回避を目的にする）。
- **repath_interval_sec**：目標点（追跡先/回り込み先）を更新する周期。短すぎるとジッター（ガタつき）になりやすい。
